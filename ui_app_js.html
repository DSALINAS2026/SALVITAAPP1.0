<script>
  const $ = (id) => document.getElementById(id);

  let TOKEN = localStorage.getItem("TOKEN") || "";
  let SESSION = null;

  let CACHE_ROWS = [];   // chasis
  let CACHE_MOV = [];    // movimientos
  let CACHE_TAREAS = []; // tareas

  let IS_ADMIN = false;
  let EDIT_ROW = null;

  let OPTIONS = { ejes: [], mapas: [], carrocerias: [] };
  let MOV_OPTS = { unidades: [], depositos: [] };
  let TAREAS_OPTS = { sistemas: [], subsistemas: [], sectores: [] };

  // movimiento state
  let MOV_TIPO = "";
  let MOV_LAST = 0;

  function render() {
    if (!TOKEN) return renderLogin();
    renderShell();
    pingSession();
  }

  function renderLogin() {
    $("app").innerHTML = `
      <div class="loginWrap">
        <div class="card">
          <div class="brand" style="margin:0 0 10px 0;color:var(--ink)">
            <div class="dot"></div><h1>Ingreso seguro</h1>
          </div>
          <p class="muted" style="margin-top:0">Acceso a gesti√≥n</p>

          <label class="muted"><b>Usuario</b></label>
          <input id="lUser" placeholder="Tu usuario" />
          <div style="height:8px"></div>
          <label class="muted"><b>Contrase√±a</b></label>
          <input id="lPass" type="password" placeholder="Tu contrase√±a" />

          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
            <button class="btn" onclick="doLogin()">Entrar</button>
          </div>

          <div id="lMsg" class="error" style="display:none"></div>
        </div>
      </div>
    `;
  }

  function renderShell() {
    $("app").innerHTML = `
      <div class="app">
        <aside class="sidebar">
          <div class="brand"><div class="dot"></div><h1>Mantenimiento</h1></div>
          <div class="nav">
            <button id="navCh" class="active" onclick="setActiveNav('ch'); showChasis();">
              <span>ChasisBD</span><small>Lista</small>
            </button>
            <button id="navMov" onclick="setActiveNav('mov'); showMovimientos();">
              <span>Movimientos</span><small>Ingreso/Egreso</small>
            </button>
            <button id="navTar" onclick="setActiveNav('tar'); showTareas();">
              <span>Maestro Tareas</span><small>Alta/Buscar</small>
            </button>
            <button id="navOT" onclick="setActiveNav('ot'); showOT();">
             <span>OT</span><small>Correct/Prev</small>
            </button>

          </div>
          <div style="margin-top:14px;opacity:.95">
            <button class="btn secondary" style="width:100%" onclick="doLogout()">Cerrar sesi√≥n</button>
          </div>
        </aside>

        <main class="main">
          <div class="topbar">
            <div class="clock" id="clock">--:--:--</div>
            <div class="userbox">
              <div class="chip"><b>Usuario:</b> <span id="uName">-</span></div>
              <div class="chip"><b>Rol:</b> <span id="uRol">-</span></div>
            </div>
          </div>

          <div id="view"></div>
        </main>
      </div>
    `;
    startClock();
  }

  function setActiveNav(which){
    $("navCh")?.classList.remove("active");
    $("navMov")?.classList.remove("active");
    $("navTar")?.classList.remove("active");
    $("navOT")?.classList.remove("active");
    if (which === "ch") $("navCh")?.classList.add("active");
    if (which === "mov") $("navMov")?.classList.add("active");
    if (which === "tar") $("navTar")?.classList.add("active");
    if (which === "ot") $("navOT")?.classList.add("active");
  }

  function startClock() {
    const tick = () => {
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      $("clock").textContent = `${hh}:${mm}:${ss}`;
    };
    tick();
    setInterval(tick, 1000);
  }

  function pingSession() {
    google.script.run.withSuccessHandler(res => {
      if (!res || !res.ok) {
        TOKEN = ""; localStorage.removeItem("TOKEN");
        SESSION = null;
        return render();
      }
      SESSION = res.user;
      IS_ADMIN = (SESSION.r === "ADMIN" || SESSION.r === "ADMINISTRADOR");
      $("uName").textContent = SESSION.n || SESSION.u;
      $("uRol").textContent = SESSION.r || "-";

      loadOptions(() =>
        loadMovOptions(() =>
          loadTareasOptions(() =>
            showChasis()
          )
        )
      );
    }).withFailureHandler(() => {
      TOKEN = ""; localStorage.removeItem("TOKEN");
      render();
    }).getSession(TOKEN);
  }

  function doLogin() {
    const u = $("lUser").value.trim();
    const p = $("lPass").value;
    $("lMsg").style.display = "none";

    google.script.run.withSuccessHandler(res => {
      if (!res.ok) {
        $("lMsg").textContent = res.msg || "Error";
        $("lMsg").style.display = "block";
        return;
      }
      TOKEN = res.token;
      localStorage.setItem("TOKEN", TOKEN);
      render();
    }).withFailureHandler(err => {
      $("lMsg").textContent = err.message || String(err);
      $("lMsg").style.display = "block";
    }).login(u, p);
  }

  function doLogout() {
    const t = TOKEN;
    TOKEN = ""; localStorage.removeItem("TOKEN");
    google.script.run.logout(t);
    render();
  }

  // ===== selects Chasis =====
  function loadOptions(cb){
    google.script.run.withSuccessHandler(res => {
      if (res && res.ok) OPTIONS = res;
      if (cb) cb();
    }).withFailureHandler(() => cb && cb()).getSelectOptions(TOKEN);
  }

  // ===== selects Mov =====
  function loadMovOptions(cb){
    google.script.run.withSuccessHandler(res => {
      if (res && res.ok) MOV_OPTS = res;
      if (cb) cb();
    }).withFailureHandler(() => cb && cb()).getMovSelectOptions(TOKEN);
  }

  // ===== selects Tareas =====
  function loadTareasOptions(cb){
    google.script.run.withSuccessHandler(res => {
      if (res && res.ok) TAREAS_OPTS = res;
      if (cb) cb();
    }).withFailureHandler(() => cb && cb()).getTareasSelectOptions(TOKEN);
  }

  function fillSelect(id, arr, currentValue){
    const el = $(id);
    if (!el) return;

    const cur = (currentValue ?? "").toString().trim();
    const list = (arr || []).slice();

    let html = `<option value="">(seleccionar)</option>`;
    list.forEach(v => {
      const sel = (v === cur) ? "selected" : "";
      html += `<option ${sel} value="${escapeHtml(v)}">${escapeHtml(v)}</option>`;
    });

    if (cur && !list.includes(cur)) {
      html = `<option selected value="${escapeHtml(cur)}">${escapeHtml(cur)}</option>` + html;
    }

    el.innerHTML = html;
  }

  function fillUnidadSelect(){
    const el = $("mUnidadSel");
    if (!el) return;
    let html = `<option value="">(seleccionar unidad)</option>`;
    (MOV_OPTS.unidades || []).forEach(u=>{
      html += `<option value="${escapeHtml(u.value)}">${escapeHtml(u.label)}</option>`;
    });
    el.innerHTML = html;
  }

  function fillDepositoSelect(current){
    const el = $("mDepositoSel");
    if (!el) return;
    const cur = (current ?? "").toString();
    let html = `<option value="">(seleccionar dep√≥sito)</option>`;
    (MOV_OPTS.depositos || []).forEach(d=>{
      const sel = d === cur ? "selected" : "";
      html += `<option ${sel} value="${escapeHtml(d)}">${escapeHtml(d)}</option>`;
    });
    html += `<option value="__OTRO__">Otro‚Ä¶</option>`;
    el.innerHTML = html;
  }

  // ===================== CHASIS VIEW =====================
  function showChasis() {
    setActiveNav("ch");
    $("view").innerHTML = `
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
          <div>
            <div style="font-size:18px;font-weight:1000">ChasisBD</div>
            <div class="muted">Visualiz√°, busc√° y (si sos ADMIN) gestion√° estados.</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <button class="btn" onclick="openAdd()" id="btnAdd" style="display:none">+ Agregar chasis</button>
            <button class="btn secondary" onclick="loadChasis()">Actualizar</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px" id="kpis"></div>

        <div class="controls">
          <input id="q" placeholder="Buscar: interno / dominio / sociedad..." oninput="applyFilter()" />
          <select id="f" onchange="applyFilter()">
            <option value="">Estado: todos</option>
            <option value="activo">activo</option>
            <option value="inactivo">inactivo</option>
            <option value="baja">baja</option>
          </select>
          <div class="muted" id="count"></div>
        </div>

        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Interno</th>
                <th>Dominio</th>
                <th>Sociedad</th>
                <th>Dep√≥sito</th>
                <th>Tipo</th>
                <th>Km</th>
                <th>Estado</th>
                <th id="thAcc" style="display:none">Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    `;
    loadChasis();
  }

  function loadChasis() {
    google.script.run.withSuccessHandler(res => {
      IS_ADMIN = !!res.isAdmin;
      $("btnAdd").style.display = IS_ADMIN ? "inline-flex" : "none";
      $("thAcc").style.display = IS_ADMIN ? "table-cell" : "none";

      const s = res.summary || {total:0,activo:0,inactivo:0,baja:0};
      $("kpis").innerHTML = `
        <div class="card kpi" style="padding:12px"><div class="n">${s.total}</div><div class="t">Unidades (total)</div></div>
        <div class="card kpi" style="padding:12px"><div class="n">${s.activo}</div><div class="t">Activas</div></div>
        <div class="card kpi" style="padding:12px"><div class="n">${s.inactivo}</div><div class="t">Inactivas</div></div>
        <div class="card kpi" style="padding:12px"><div class="n">${s.baja}</div><div class="t">Baja</div></div>
      `;

      CACHE_ROWS = res.rows || [];
      applyFilter();
    }).withFailureHandler(err => {
      $("tbody").innerHTML = `<tr><td colspan="8" class="error">${err.message || err}</td></tr>`;
    }).listChasis(TOKEN);
  }

  function applyFilter() {
    const q = ($("q")?.value || "").toLowerCase().trim();
    const f = ($("f")?.value || "").toLowerCase().trim();

    const rows = CACHE_ROWS.filter(r => {
      const blob = `${r.Interno} ${r.Dominio} ${r.Sociedad} ${r.Deposito} ${r.Tipo}`.toLowerCase();
      const okQ = !q || blob.includes(q);
      const okF = !f || (r.Estado === f);
      return okQ && okF;
    });

    $("count").textContent = `${rows.length} resultado(s)`;

    $("tbody").innerHTML = rows.map(r => {
      const est = (r.Estado || "activo");
      const estadoBadge = `<span class="estado ${est}"><span class="dot2"></span>${est}</span>`;

      const acc = IS_ADMIN ? `
        <td>
          <div class="actions">
            <button class="mini" onclick="quickEdit(${r._row})">Editar</button>
            <button class="mini" onclick="setEstado(${r._row},'activo')">Activo</button>
            <button class="mini" onclick="setEstado(${r._row},'inactivo')">Inactivo</button>
            <button class="mini" onclick="setEstado(${r._row},'baja')">Baja</button>
          </div>
        </td>` : ``;

      return `
        <tr>
          <td><b>${escapeHtml(r.Interno)}</b></td>
          <td>${escapeHtml(r.Dominio)}</td>
          <td>${escapeHtml(r.Sociedad)}</td>
          <td>${escapeHtml(r.Deposito)}</td>
          <td>${escapeHtml(r.Tipo)}</td>
          <td>${escapeHtml(r.KmRecorridos)}</td>
          <td>${estadoBadge}</td>
          ${IS_ADMIN ? acc : ""}
        </tr>
      `;
    }).join("") || `<tr><td colspan="${IS_ADMIN?8:7}" class="muted">Sin resultados.</td></tr>`;
  }

  function setEstado(row, estado) {
    google.script.run.withSuccessHandler(() => {
      toast("‚úÖ Estado actualizado");
      loadChasis();
      loadMovOptions();
    }).withFailureHandler(err => alert(err.message || err))
      .setChasisEstado(TOKEN, row, estado);
  }

  function quickEdit(row) {
    if (!IS_ADMIN) return alert("Solo administradores pueden editar.");
    const r = CACHE_ROWS.find(x => x._row === row);
    if (!r) return;

    EDIT_ROW = row;
    $("editMsg").style.display = "none";

    $("eInterno").value = r.Interno || "";
    $("eDominio").value = r.Dominio || "";
    $("eSociedad").value = r.Sociedad || "";
    $("eDeposito").value = r.Deposito || "";
    $("eTipo").value = r.Tipo || "";
    $("eKm").value = r.KmRecorridos || "";

    $("eCapacidad").value = r.CapacidadCarga || "";
    $("eNroChasis").value = r["Nro. Chasis"] || "";
    $("eMarca").value = r.Marca || "";
    $("eModelo").value = r.Modelo || "";
    $("eMotor").value = r.Motor || "";
    $("eNroMotor").value = r["Nro Motor"] || "";

    $("eAnio").value = r["A√±o"] || "";

    fillSelect("eEje", OPTIONS.ejes, r.Eje || "");
    fillSelect("eMapa", OPTIONS.mapas, r["Mapa Cubierta"] || "");
    fillSelect("eCarroceria", OPTIONS.carrocerias, r.Carroceria || "");

    $("eEstado").value = (r.Estado || "activo").toLowerCase();

    $("modalEdit").style.display = "flex";
  }

  function closeEdit(){ $("modalEdit").style.display = "none"; EDIT_ROW = null; }

  function showEditErr(msg){
    if (!msg){ $("editMsg").style.display = "none"; return; }
    $("editMsg").textContent = msg;
    $("editMsg").style.display = "block";
  }

  function saveEdit(){
    if (!EDIT_ROW) return;

    const Interno = $("eInterno").value.trim();
    const Dominio = $("eDominio").value.trim();
    if (!Interno) return showEditErr("Interno es obligatorio.");
    if (!Dominio) return showEditErr("Dominio/Patente es obligatorio.");
    showEditErr("");

    setLoading("btnSaveEdit", true);

    const fields = {
      Interno,
      Dominio,
      Sociedad: $("eSociedad").value.trim(),
      Deposito: $("eDeposito").value.trim(),
      Tipo: $("eTipo").value.trim(),
      KmRecorridos: $("eKm").value.trim() || "0",
      CapacidadCarga: $("eCapacidad").value.trim(),
      "Nro. Chasis": $("eNroChasis").value.trim(),
      Marca: $("eMarca").value.trim(),
      Modelo: $("eModelo").value.trim(),
      Motor: $("eMotor").value.trim(),
      "Nro Motor": $("eNroMotor").value.trim(),
      "A√±o": $("eAnio").value.trim(),
      Eje: $("eEje").value,
      "Mapa Cubierta": $("eMapa").value,
      Carroceria: $("eCarroceria").value,
      Estado: $("eEstado").value
    };

    google.script.run.withSuccessHandler(() => {
      setLoading("btnSaveEdit", false);
      closeEdit();
      toast("‚úÖ Cambios guardados");
      loadChasis();
      loadMovOptions();
    }).withFailureHandler(err => {
      setLoading("btnSaveEdit", false);
      showEditErr(err.message || String(err));
    }).updateChasisFields(TOKEN, EDIT_ROW, fields);
  }

  function openAdd() {
    if (!IS_ADMIN) return alert("Solo administradores pueden agregar.");
    $("addMsg").style.display = "none";
    $("modalAdd").style.display = "flex";

    [
      "fInterno","fDominio","fSociedad","fDeposito","fTipo","fKm",
      "fCapacidad","fNroChasis","fMarca","fModelo","fMotor","fNroMotor","fAnio"
    ].forEach(id => $(id).value = "");

    $("fEstado").value = "activo";
    fillSelect("fEje", OPTIONS.ejes, "");
    fillSelect("fMapa", OPTIONS.mapas, "");
    fillSelect("fCarroceria", OPTIONS.carrocerias, "");
  }

  function closeAdd(){ $("modalAdd").style.display = "none"; }

  function saveAdd() {
    $("addMsg").style.display = "none";
    setLoading("btnSaveAdd", true);

    const payload = {
      Interno: $("fInterno").value.trim(),
      Dominio: $("fDominio").value.trim(),
      Sociedad: $("fSociedad").value.trim(),
      Deposito: $("fDeposito").value.trim(),
      Tipo: $("fTipo").value.trim(),
      KmRecorridos: $("fKm").value.trim() || "0",
      CapacidadCarga: $("fCapacidad").value.trim(),
      "Nro. Chasis": $("fNroChasis").value.trim(),
      Marca: $("fMarca").value.trim(),
      Modelo: $("fModelo").value.trim(),
      Motor: $("fMotor").value.trim(),
      "Nro Motor": $("fNroMotor").value.trim(),
      "A√±o": $("fAnio").value.trim(),
      Eje: $("fEje").value,
      "Mapa Cubierta": $("fMapa").value,
      Carroceria: $("fCarroceria").value,
      Estado: $("fEstado").value
    };

    google.script.run.withSuccessHandler(() => {
      setLoading("btnSaveAdd", false);
      closeAdd();
      toast("‚úÖ Chasis guardado");
      loadChasis();
      loadMovOptions();
    }).withFailureHandler(err => {
      setLoading("btnSaveAdd", false);
      $("addMsg").textContent = err.message || String(err);
      $("addMsg").style.display = "block";
    }).addChasis(TOKEN, payload);
  }

  // ===================== MOVIMIENTOS VIEW (PRO) =====================
  function showMovimientos(){
    setActiveNav("mov");
    $("view").innerHTML = `
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
          <div>
            <div style="font-size:18px;font-weight:1000">MovimientoUnidad</div>
            <div class="muted">B√∫squeda por interno + rango de fechas + filtros pro.</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <button class="btn" onclick="openMov()">+ Nuevo movimiento</button>
            <button class="btn secondary" onclick="loadMovimientos()">Actualizar</button>
          </div>
        </div>

        <div class="controls">
          <input id="mq" placeholder="Buscar interno..." oninput="applyMovFilter()" />
          <select id="mt" onchange="applyMovFilter()">
            <option value="">Tipo: todos</option>
            <option value="ingreso">ingreso</option>
            <option value="egreso">egreso</option>
          </select>

          <select id="mdepSel" onchange="applyMovFilter()">
            <option value="">Dep√≥sito: todos</option>
          </select>

          <input id="mfrom" type="date" onchange="applyMovFilter()" />
          <input id="mto" type="date" onchange="applyMovFilter()" />

          <div class="muted" id="mcount"></div>
        </div>

        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Fecha/Hora</th>
                <th>Unidad</th>
                <th>Tipo</th>
                <th>Dep√≥sito</th>
                <th>√öltimo</th>
                <th>Od√≥metro</th>
                <th>Km</th>
                <th>Obs.</th>
              </tr>
            </thead>
            <tbody id="mtbody"></tbody>
          </table>
        </div>
      </div>
    `;

    fillSelect("mdepSel", MOV_OPTS.depositos || [], "");
    if ($("mdepSel")?.options?.length) $("mdepSel").options[0].text = "Dep√≥sito: todos";

    loadMovimientos();
  }

  function loadMovimientos(){
    google.script.run.withSuccessHandler(res => {
      CACHE_MOV = res.rows || [];
      applyMovFilter();
    }).withFailureHandler(err => {
      $("mtbody").innerHTML = `<tr><td colspan="8" class="error">${err.message || err}</td></tr>`;
    }).listMovimientos(TOKEN);
  }

  function applyMovFilter(){
    const q = ($("mq")?.value || "").toLowerCase().trim();
    const tipo = ($("mt")?.value || "").toLowerCase().trim();
    const dep = ($("mdepSel")?.value || "").toLowerCase().trim();

    const from = $("mfrom")?.value ? new Date($("mfrom").value + "T00:00:00").getTime() : null;
    const to = $("mto")?.value ? new Date($("mto").value + "T23:59:59").getTime() : null;

    const rows = CACHE_MOV.filter(r => {
      const okQ = !q || (r.Unidad || "").toLowerCase().includes(q);
      const okT = !tipo || (r.Tipo || "").toLowerCase() === tipo;
      const okD = !dep || (r.Deposito || "").toLowerCase() === dep;

      const fm = r.FechaMovMs ?? null;
      const okF = (!from || (fm !== null && fm >= from)) && (!to || (fm !== null && fm <= to));

      return okQ && okT && okD && okF;
    });

    $("mcount").textContent = `${rows.length} movimiento(s)`;

    $("mtbody").innerHTML = rows.map(r => `
      <tr>
        <td><b>${fmtDate(r.FechaMovMs)} ${escapeHtml(r.HoraMov || "")}</b></td>
        <td><b>${escapeHtml(r.Unidad)}</b></td>
        <td>${escapeHtml(r.Tipo)}</td>
        <td>${escapeHtml(r.Deposito)}</td>
        <td>${escapeHtml(String(r.UltimoOdometro ?? 0))}</td>
        <td>${escapeHtml(String(r.Odometro ?? 0))}</td>
        <td>${escapeHtml(String(r.KmRecorridos ?? 0))}</td>
        <td>${escapeHtml((r.Observacion || "").slice(0,40))}</td>
      </tr>
    `).join("") || `<tr><td colspan="8" class="muted">Sin resultados.</td></tr>`;
  }

  function setTipoMov(t){
    MOV_TIPO = t;
    $("tIngreso")?.classList.toggle("active", t === "ingreso");
    $("tEgreso")?.classList.toggle("active", t === "egreso");
    validateMovInputs();
  }

  function openMov(){
    $("movMsg").style.display = "none";
    $("modalMov").style.display = "flex";

    MOV_TIPO = "";
    MOV_LAST = 0;

    setTipoMov("");
    $("mUlt").value = "";
    $("mOdo").value = "";
    $("mKm").value = "";
    $("mObs").value = "";
    $("mDepositoOtherWrap").style.display = "none";
    $("mDepositoOther").value = "";

    const now = new Date();
    $("mFecha").value = now.toISOString().slice(0,10);
    $("mHora").value = now.toTimeString().slice(0,5);

    fillUnidadSelect();
    fillDepositoSelect("");

    $("mDepositoSel").onchange = () => {
      const v = $("mDepositoSel").value;
      const show = (v === "__OTRO__");
      $("mDepositoOtherWrap").style.display = show ? "block" : "none";
      if (!show) $("mDepositoOther").value = "";
      validateMovInputs();
    };

    $("mUnidadSel").onchange = () => {
      const unidad = $("mUnidadSel").value.trim();
      MOV_LAST = 0;
      $("mUlt").value = "";
      $("mKm").value = "";
      $("mOdo").value = "";
      validateMovInputs();

      if (!unidad) return;

      google.script.run.withSuccessHandler(res => {
        const last = Number(res?.last || 0);
        MOV_LAST = last;
        $("mUlt").value = String(last);
        calcKmLive();
        validateMovInputs();

        const u = (MOV_OPTS.unidades || []).find(x => x.value === unidad);
        if (u && u.deposito) {
          fillDepositoSelect(u.deposito);
        }
      }).withFailureHandler(err => {
        showMovErr(err.message || String(err));
      }).getUltimoOdometer(TOKEN, unidad);
    };

    $("mOdo").oninput = () => {
      calcKmLive();
      validateMovInputs();
    };

    $("mFecha").onchange = validateMovInputs;
    $("mHora").onchange = validateMovInputs;

    validateMovInputs();
  }

  function closeMov(){ $("modalMov").style.display = "none"; }

  function calcKmLive(){
    const odo = parseInt(($("mOdo").value || "").toString().replace(/[^\d]/g,""), 10);
    if (!isFinite(odo)) { $("mKm").value = ""; return; }
    const km = odo - (MOV_LAST || 0);
    $("mKm").value = String(isFinite(km) ? km : "");
  }

  function validateMovInputs(){
    const unidad = $("mUnidadSel").value.trim();
    const fecha = $("mFecha").value;
    const hora = $("mHora").value;

    let dep = $("mDepositoSel").value.trim();
    if (dep === "__OTRO__") dep = $("mDepositoOther").value.trim();

    const odo = parseInt(($("mOdo").value || "").toString().replace(/[^\d]/g,""), 10);

    let err = "";

    if (!unidad) err = "Unidad es obligatoria.";
    else if (!MOV_TIPO) err = "Eleg√≠ Tipo: Ingreso o Egreso.";
    else if (!fecha) err = "Fecha es obligatoria.";
    else if (!hora) err = "Hora es obligatoria.";
    else if (!dep) err = "Dep√≥sito es obligatorio.";
    else if (!isFinite(odo) || odo <= 0) err = "Od√≥metro inv√°lido.";
    else if (isFinite(MOV_LAST) && odo < MOV_LAST) err = `Od√≥metro no puede ser menor al √∫ltimo (${MOV_LAST}).`;

    const btn = $("btnSaveMov");
    if (err) {
      btn.style.pointerEvents = "none";
      btn.style.opacity = "0.7";
      $("mOdoHint").innerHTML = `<span class="error">${escapeHtml(err)}</span>`;
    } else {
      btn.style.pointerEvents = "";
      btn.style.opacity = "";
      $("mOdoHint").innerHTML = `Ok. Km se calcula autom√°ticamente.`;
    }
  }

  function showMovErr(msg){
    $("movMsg").textContent = msg;
    $("movMsg").style.display = "block";
  }

  function saveMov(){
    $("movMsg").style.display = "none";

    const Unidad = $("mUnidadSel").value.trim();
    const FechaISO = $("mFecha").value;
    const HoraMov = $("mHora").value;

    let Deposito = $("mDepositoSel").value.trim();
    if (Deposito === "__OTRO__") Deposito = $("mDepositoOther").value.trim();

    const Odometro = parseInt(($("mOdo").value || "").toString().replace(/[^\d]/g,""), 10);
    const Observacion = $("mObs").value.trim();

    if (!Unidad) return showMovErr("Unidad es obligatoria.");
    if (!MOV_TIPO) return showMovErr("Eleg√≠ Tipo: Ingreso o Egreso.");
    if (!FechaISO) return showMovErr("Fecha es obligatoria.");
    if (!HoraMov) return showMovErr("Hora es obligatoria.");
    if (!Deposito) return showMovErr("Dep√≥sito es obligatorio.");
    if (!isFinite(Odometro) || Odometro <= 0) return showMovErr("Od√≥metro inv√°lido.");
    if (Odometro < (MOV_LAST || 0)) return showMovErr(`Od√≥metro no puede ser menor al √∫ltimo (${MOV_LAST}).`);

    setLoading("btnSaveMov", true);

    google.script.run.withSuccessHandler(() => {
      setLoading("btnSaveMov", false);
      toast("‚úÖ Movimiento guardado");
      closeMov();
      loadMovimientos();
      loadChasis();
      loadMovOptions();
    }).withFailureHandler(err => {
      setLoading("btnSaveMov", false);
      showMovErr(err.message || String(err));
    }).addMovimiento(TOKEN, { Unidad, Tipo: MOV_TIPO, FechaISO, HoraMov, Odometro, Deposito, Observacion });
  }

  // ===================== MAESTRO TAREAS =====================
  function showTareas(){
    setActiveNav("tar");
    $("view").innerHTML = `
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
          <div>
            <div style="font-size:18px;font-weight:1000">MaestroTareas</div>
            <div class="muted">Busc√° por c√≥digo/nombre y filtr√° por sistema, subsistema y sector.</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <button class="btn" onclick="openTarea()">+ Agregar tarea</button>
            <button class="btn secondary" onclick="loadTareas()">Actualizar</button>
          </div>
        </div>

        <div class="controls">
        <input id="tq" placeholder="Buscar: c√≥digo o nombre..." oninput="applyTareasFilter()" />

         <select id="tsis" onchange="applyTareasFilter()">
           <option value="">Sistema: todos</option>
           </select>

           <select id="tsubf" onchange="applyTareasFilter()">
            <option value="">Subsistema: todos</option>
           </select>

           <select id="tsecf" onchange="applyTareasFilter()">
           <option value="">Sector: todos</option>
             </select>

            <label class="muted" style="display:flex;align-items:center;gap:8px;font-weight:900">
           <input id="tShowDel" type="checkbox" onchange="toggleVerEliminados()" style="min-width:auto;width:auto"/>
            Ver eliminados
           </label>

            <button class="btn secondary" onclick="resetTareasFilters()">Limpiar</button>

             <div class="muted" id="tcount"></div>
              </div>


        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Nombre</th>
                <th>Sistema</th>
                <th>Subsistema</th>
                <th>Sector</th>
                <th style="width:120px">Acci√≥n</th>
              </tr>
            </thead>
            <tbody id="ttbody"></tbody>
          </table>
        </div>
      </div>
    `;

    loadTareasOptions(() => {
      fillTareasFilterSelects_();
      loadTareas();
    });
  }

  function fillTareasFilterSelects_(){
    const sis = $("tsis"), sub = $("tsubf"), sec = $("tsecf");
    if (!sis || !sub || !sec) return;

    sis.innerHTML = `<option value="">Sistema: todos</option>` + (TAREAS_OPTS.sistemas||[]).map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join("");
    sub.innerHTML = `<option value="">Subsistema: todos</option>` + (TAREAS_OPTS.subsistemas||[]).map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join("");
    sec.innerHTML = `<option value="">Sector: todos</option>` + (TAREAS_OPTS.sectores||[]).map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join("");
  }

  function loadTareas(){
    const showDel = !!$("tShowDel")?.checked;
    const fn = showDel ? "listTareasIncluyendoEliminadas" : "listTareas";

    google.script.run.withSuccessHandler(res => {
      CACHE_TAREAS = res.rows || [];
      applyTareasFilter();
    }).withFailureHandler(err => {
      $("ttbody").innerHTML = `<tr><td colspan="6" class="error">${err.message || err}</td></tr>`;
    })[fn](TOKEN);
  }

  function applyTareasFilter(){
    const q = ($("tq")?.value || "").toLowerCase().trim();
    const sis = ($("tsis")?.value || "").toLowerCase().trim();
    const sub = ($("tsubf")?.value || "").toLowerCase().trim();
    const sec = ($("tsecf")?.value || "").toLowerCase().trim();

    const showDel = !!$("tShowDel")?.checked;

    const rows = CACHE_TAREAS.filter(r => {
      if (!showDel && (r.borrado === true || String(r.borrado).toLowerCase() === "true")) return false;

      const blob = `${r.codigo} ${r.nombre}`.toLowerCase();
      const okQ = !q || blob.includes(q);
      const okS = !sis || (r.sistema||"").toLowerCase() === sis;
      const okSub = !sub || (r.subsistema||"").toLowerCase() === sub;
      const okSec = !sec || (r.sector||"").toLowerCase() === sec;
      return okQ && okS && okSub && okSec;
    });

    $("tcount").textContent = `${rows.length} tarea(s)`;

    $("ttbody").innerHTML = rows.map(r => `
      <tr>
        <td><b>${escapeHtml(r.codigo)}</b></td>
        <td>${escapeHtml(r.nombre)}</td>
        <td>${escapeHtml(r.sistema)}</td>
        <td>${escapeHtml(r.subsistema)}</td>
        <td>${escapeHtml(r.sector)}</td>
        <td>
          ${ (r.borrado === true || String(r.borrado).toLowerCase() === "true")
              ? `<span class="muted"><b>Eliminada</b></span>`
              : `<button class="mini" onclick="confirmBorrarTarea(${r._row})">Borrar</button>` }
        </td>
      </tr>
    `).join("") || `<tr><td colspan="6" class="muted">Sin resultados.</td></tr>`;
  }

  function toggleVerEliminados(){
    loadTareas();
  }

  function resetTareasFilters(){
    if ($("tq")) $("tq").value = "";
    if ($("tsis")) $("tsis").value = "";
    if ($("tsubf")) $("tsubf").value = "";
    if ($("tsecf")) $("tsecf").value = "";
    applyTareasFilter();
  }

  function openTarea(){
    if (!$("modalTarea")) return alert("No se encontr√≥ modalTarea. Revis√° ui_modals.html.");

    $("tMsg").style.display = "none";
    $("modalTarea").style.display = "flex";

    $("tcodigo").value = "";
    $("tnombre").value = "";

    $("tsistema").innerHTML = `<option value="">(seleccionar)</option>` + (TAREAS_OPTS.sistemas||[]).map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join("");
    $("tsubsistema").innerHTML = `<option value="">(seleccionar)</option>` + (TAREAS_OPTS.subsistemas||[]).map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join("");
    $("tsector").innerHTML = `<option value="">(seleccionar)</option>` + (TAREAS_OPTS.sectores||[]).map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join("");
  }

  function closeTarea(){ $("modalTarea").style.display = "none"; }

  function showTareaErr(msg){
    $("tMsg").textContent = msg;
    $("tMsg").style.display = "block";
  }

  function saveTarea(){
    $("tMsg").style.display = "none";

    const codigo = $("tcodigo").value.trim();
    const nombre = $("tnombre").value.trim();
    const sistema = $("tsistema").value.trim();
    const subsistema = $("tsubsistema").value.trim();
    const sector = $("tsector").value.trim();

    if (!codigo) return showTareaErr("C√≥digo es obligatorio.");
    if (!nombre) return showTareaErr("Nombre es obligatorio.");
    if (!sistema) return showTareaErr("Sistema es obligatorio.");
    if (!subsistema) return showTareaErr("Subsistema es obligatorio.");
    if (!sector) return showTareaErr("Sector es obligatorio.");

    setLoading("btnSaveTarea", true);

    google.script.run.withSuccessHandler(() => {
      setLoading("btnSaveTarea", false);
      toast("‚úÖ Tarea guardada");
      closeTarea();
      loadTareasOptions(()=>{});
      loadTareas();
    }).withFailureHandler(err => {
      setLoading("btnSaveTarea", false);
      showTareaErr(err.message || String(err));
    }).addTarea(TOKEN, { codigo, nombre, sistema, subsistema, sector });
  }

  let TAREA_DEL_ROW = null;

  function confirmBorrarTarea(row){
    const r = CACHE_TAREAS.find(x => x._row === row);
    if (!r) return alert("No se encontr√≥ la tarea.");

    TAREA_DEL_ROW = row;

    $("cDelCod").textContent = r.codigo || "-";
    $("cDelNom").textContent = r.nombre || "-";
    $("cDelMsg").style.display = "none";

    $("modalConfirmTarea").style.display = "flex";
  }

  function closeConfirmTarea(){
    $("modalConfirmTarea").style.display = "none";
    TAREA_DEL_ROW = null;
  }

  function doBorrarTarea(){
    if (!TAREA_DEL_ROW) return;

    $("cDelMsg").style.display = "none";
    setLoading("btnConfirmDelTarea", true);

    google.script.run.withSuccessHandler(() => {
      setLoading("btnConfirmDelTarea", false);
      toast("üóëÔ∏è Tarea eliminada");
      closeConfirmTarea();
      loadTareasOptions(()=>{});
      loadTareas();
    }).withFailureHandler(err => {
      setLoading("btnConfirmDelTarea", false);
      $("cDelMsg").textContent = err.message || String(err);
      $("cDelMsg").style.display = "block";
    }).borrarTarea(TOKEN, TAREA_DEL_ROW);
  }

  // ===================== UTIL =====================
  function setLoading(btnId, isLoading){
    const b = $(btnId);
    if (!b) return;
    b.classList.toggle("loading", !!isLoading);
  }

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 1500);
  }

  function escapeHtml(s){
    s = (s ?? "").toString();
    return s.replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function fmtDate(ms){
    if (!ms) return "";
    const d = new Date(ms);
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    return `${dd}-${mm}-${yy}`;
  }

  function fmtOT(n){
    const s = String(n ?? "").replace(/[^\d]/g,"");
    if (!s) return "";
    return s.padStart(6,"0");
  }

  window.addEventListener("click", (e) => {
    if (e.target === $("modalAdd")) closeAdd();
    if (e.target === $("modalEdit")) closeEdit();
    if (e.target === $("modalMov")) closeMov();
    if (e.target === $("modalTarea")) closeTarea();
    if (e.target === $("modalConfirmTarea")) closeConfirmTarea();
    if (e.target === $("modalOTView")) closeOTView();
    if (e.target === $("modalOTConfirm")) closeOTConfirm();
    if (e.target === $("modalOTNew")) closeOTNew();
  });

  // ===================== OT MODULE (on-demand) =====================
  let OT_CACHE = [];
  let OT_SELECTED = null; // {head,tasks}
  let OT_FILTERS = { estados:[], sociedades:[], depositos:[], sectores:[] };
  let OT_EMPL = { empleados:[] };

  function showOT(){
    setActiveNav("ot");

    $("view").innerHTML = `
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
          <div>
            <div style="font-size:18px;font-weight:1000">√ìrdenes de Trabajo (OT)</div>
            <div class="muted">No carga todo: busc√° por <b>Interno</b> o <b>N¬∞ OT</b> y toc√° Buscar.</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <button class="btn" onclick="openOTNew()">+ Nueva OT</button>
            <button class="btn secondary" onclick="loadOTOptions()">Actualizar filtros</button>
          </div>
        </div>

        <div class="controls">
          <input id="otInterno" placeholder="Interno (ej: 1234)" />
          <input id="otNro" placeholder="N¬∞ OT (solo n√∫meros)" inputmode="numeric" />
          <button class="btn" onclick="searchOT_UI()">Buscar</button>
          <button class="btn secondary" onclick="resetOT_UI()">Limpiar</button>
        </div>

        <div class="card" style="margin-top:10px">
          <div class="muted"><b>Tipo de OT</b></div>
          <div class="radioRow" style="margin-top:8px">
            <label class="rchip"><input type="radio" name="otTipo" value="" checked> Todas</label>
            <label class="rchip"><input type="radio" name="otTipo" value="correctiva"> Correctivas</label>
            <label class="rchip"><input type="radio" name="otTipo" value="preventiva"> Preventivas</label>
          </div>
        </div>

        <div class="controls" style="margin-top:10px">
          <select id="otEstado"><option value="">Estado: todos</option></select>
          <select id="otSoc"><option value="">Sociedad: todas</option></select>
          <select id="otDep"><option value="">Dep√≥sito: todos</option></select>
          <select id="otSec"><option value="">Sector: todos</option></select>
          <select id="otEstT"><option value="">Estado tarea: todos</option>
            <option value="pendiente">pendiente</option>
            <option value="ok">ok</option>
          </select>
          <div class="muted" id="otCount"></div>
        </div>

        <div style="overflow:auto;margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>N¬∞ OT</th>
                <th>Interno</th>
                <th>Tipo</th>
                <th>Estado</th>
                <th>Sociedad</th>
                <th>Dep√≥sito</th>
                <th>Sector</th>
                <th>Ver</th>
              </tr>
            </thead>
            <tbody id="otBody">
              <tr><td colspan="9" class="muted">Esperando b√∫squeda‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    `;

    $("otNro").addEventListener("input", () => {
      $("otNro").value = $("otNro").value.replace(/[^\d]/g,"");
    });

    loadOTOptions();
  }

  function loadOTOptions(){
    google.script.run.withSuccessHandler(res=>{
      if (res?.ok){
        OT_FILTERS = res;
        fillSelect("otEstado", (res.estados||[]), "");
        fillSelect("otSoc", res.sociedades||[], "");
        fillSelect("otDep", res.depositos||[], "");
        fillSelect("otSec", res.sectores||[], "");
      }
    }).getOTFiltersOptions(TOKEN);

    google.script.run.withSuccessHandler(res=>{
      if (res?.ok) OT_EMPL = res;
    }).getEmpleadosOptions(TOKEN);
  }

  function resetOT_UI(){
    $("otInterno").value = "";
    $("otNro").value = "";
    $("otEstado").value = "";
    $("otSoc").value = "";
    $("otDep").value = "";
    $("otSec").value = "";
    $("otEstT").value = "";
    document.querySelectorAll("input[name='otTipo']").forEach(r=> r.checked = (r.value===""));
    $("otBody").innerHTML = `<tr><td colspan="9" class="muted">Esperando b√∫squeda‚Ä¶</td></tr>`;
    $("otCount").textContent = "";
    OT_CACHE = [];
  }

  function _getTipoRadio_(){
    const el = document.querySelector("input[name='otTipo']:checked");
    return el ? el.value : "";
  }

  function searchOT_UI(){
    const interno = $("otInterno").value.trim();
    const nroOT = $("otNro").value.trim();

    const q = {
      interno,
      nroOT,
      tipo: _getTipoRadio_(),
      estado: $("otEstado").value,
      sociedad: $("otSoc").value,
      deposito: $("otDep").value,
      sector: $("otSec").value,
      estadoTarea: $("otEstT").value
    };

    google.script.run.withSuccessHandler(res=>{
      OT_CACHE = res.rows || [];
      $("otCount").textContent = `${OT_CACHE.length} OT(s)`;
      $("otBody").innerHTML = OT_CACHE.map(r=>`
        <tr>
          <td>${fmtDate(r.FechaMs)}</td>
          <td><b>${escapeHtml(fmtOT(r.NroOT))}</b></td>
          <td>${escapeHtml(r.Interno)}</td>
          <td>${escapeHtml(r.TipoOT)}</td>
          <td>${escapeHtml(r.EstadoOT)}</td>
          <td>${escapeHtml(r.Sociedad)}</td>
          <td>${escapeHtml(r.Deposito)}</td>
          <td>${escapeHtml(r.Sector)}</td>
          <td><button class="iconBtn" onclick="openOTView('${escapeHtml(r.IdOT)}')">üëÅÔ∏è</button></td>
        </tr>
      `).join("") || `<tr><td colspan="9" class="muted">Sin resultados.</td></tr>`;
    }).withFailureHandler(err=>{
      $("otBody").innerHTML = `<tr><td colspan="9" class="error">${escapeHtml(err.message||String(err))}</td></tr>`;
    }).searchOT(TOKEN, q);
  }

  // ===================== OT VIEW / CONFIRM =====================
  function openOTView(idOT){
    $("vOTMsg").style.display = "none";
    google.script.run.withSuccessHandler(res=>{
      OT_SELECTED = res;

      const h = res.head;
      $("vNro").textContent = h.NroOT || "-";
      $("vTipo").textContent = h.TipoOT || "-";
      $("vEstado").textContent = h.EstadoOT || "-";
      $("vFecha").textContent = fmtDate(h.FechaMs);

      $("vInt").textContent = h.Interno || "-";
      $("vDom").textContent = h.Dominio || "-";
      $("vSoc").textContent = h.Sociedad || "-";
      $("vDep").textContent = h.Deposito || "-";
      $("vSec").textContent = h.Sector || "-";
      $("vDesc").textContent = h.Descripcion || "";

      const tasks = (res.tasks||[]);
      $("vTasks").innerHTML = tasks.map(t=>`
        <div class="taskRow">
          <div style="min-width:18px">${t.Check ? "‚úÖ" : "‚¨ú"}</div>
          <div style="flex:1">
            <div><b>${escapeHtml(t.CodigoTarea)}</b> ‚Äî ${escapeHtml(t.NombreTarea)}</div>
            <div class="muted" style="font-size:12px">${escapeHtml(t.Sistema)} / ${escapeHtml(t.Subsistema)} / ${escapeHtml(t.Sector)} ‚Äî ${escapeHtml(t.EstadoTarea)}</div>
          </div>
        </div>
      `).join("") || `<div class="muted">Sin tareas.</div>`;

      $("modalOTView").style.display = "flex";
    }).withFailureHandler(err=>{
      alert(err.message || String(err));
    }).getOTDetails(TOKEN, idOT);
  }

  function closeOTView(){ $("modalOTView").style.display = "none"; }

  function openOTConfirm(){
    if (!OT_SELECTED?.head?.IdOT) return;

    const opts = (OT_EMPL.empleados||[]);
    const sel = (id)=>{
      const el = $(id);
      if (!el) return;
      el.innerHTML = `<option value="">(seleccionar)</option>` + opts.map(o=>`<option value="${escapeHtml(o.value)}">${escapeHtml(o.label)}</option>`).join("");
    };
    sel("op1"); sel("op2"); sel("op3"); sel("op4"); sel("sup1");

    const tasks = (OT_SELECTED.tasks||[]);
    $("cTasks").innerHTML = tasks.map(t=>`
      <div class="taskRow">
        <input type="checkbox" class="otchk" data-row="${t._row}" checked />
        <div style="flex:1">
          <div><b>${escapeHtml(t.CodigoTarea)}</b> ‚Äî ${escapeHtml(t.NombreTarea)}</div>
          <div class="muted" style="font-size:12px">${escapeHtml(t.Sistema)} / ${escapeHtml(t.Subsistema)} / ${escapeHtml(t.Sector)}</div>
        </div>
      </div>
    `).join("") || `<div class="muted">Sin tareas.</div>`;

    $("cOTMsg").style.display = "none";
    $("modalOTConfirm").style.display = "flex";
  }

  function closeOTConfirm(){ $("modalOTConfirm").style.display = "none"; }

  function saveOTConfirm(){
    const idOT = OT_SELECTED?.head?.IdOT;
    if (!idOT) return;

    const operarios = ["op1","op2","op3","op4"].map(id => $(id).value).filter(Boolean);
    const supervisor = $("sup1").value;

    if (operarios.length !== 4){
      $("cOTMsg").textContent = "Deb√©s seleccionar 4 operarios.";
      $("cOTMsg").style.display = "block";
      return;
    }
    if (new Set(operarios).size !== 4){
      $("cOTMsg").textContent = "No pod√©s repetir operarios.";
      $("cOTMsg").style.display = "block";
      return;
    }
    if (!supervisor){
      $("cOTMsg").textContent = "Supervisor es obligatorio.";
      $("cOTMsg").style.display = "block";
      return;
    }

    const checks = Array.from(document.querySelectorAll(".otchk")).map(ch => ({
      row: Number(ch.getAttribute("data-row")),
      checked: !!ch.checked
    }));

    setLoading("btnSaveOTConfirm", true);
    google.script.run.withSuccessHandler(res=>{
      setLoading("btnSaveOTConfirm", false);
      toast(`‚úÖ OT ${res.estadoOT.toUpperCase()} (${res.ok}/${res.total})`);
      closeOTConfirm();
      closeOTView();
      searchOT_UI();
    }).withFailureHandler(err=>{
      setLoading("btnSaveOTConfirm", false);
      $("cOTMsg").textContent = err.message || String(err);
      $("cOTMsg").style.display = "block";
    }).confirmarOT(TOKEN, { idOT, operarios, supervisor, checks });
  }

  function openOTAnular(){
    const idOT = OT_SELECTED?.head?.IdOT;
    if (!idOT) return;
    const motivo = prompt("Motivo de anulaci√≥n (opcional):") || "";
    google.script.run.withSuccessHandler(()=>{
      toast("‚õî OT anulada");
      closeOTView();
      searchOT_UI();
    }).withFailureHandler(err=>alert(err.message||String(err)))
      .anularOT(TOKEN, idOT, motivo);
  }

  function printOT(){
    alert("Imprimir OT: siguiente paso (con plantilla Google Doc + PDF).");
  }

  // ===================== CREAR OT (CORRECTIVA) =====================
  let OT_CREATE = { unidades:[], sistemas:[], subsistemas:[], sectores:[], tareas:[] };

function applyOTUnidad_(){
  const v = ($("nOTInterno")?.value || "").trim();
  const u = (OT_CREATE.unidades || []).find(x => String(x.value).trim() === v);

  if (!u){
    $("nOTDominio").value  = "";
    $("nOTSociedad").value = "";
    $("nOTDeposito").value = "";
    return;
  }

  $("nOTDominio").value  = (u.dominio  || "").toString();
  $("nOTSociedad").value = (u.sociedad || "").toString();
  $("nOTDeposito").value = (u.deposito || "").toString();
}



  function openOTNew(){
  $("nOTMsg").style.display = "none";
  $("modalOTNew").style.display = "flex";

  google.script.run.withSuccessHandler(res=>{
    if (!res?.ok) return;

    OT_CREATE = res;

    // ===== UNIDADES =====
    const uSel = $("nOTInterno");
    uSel.innerHTML = `<option value="">(seleccionar unidad)</option>` +
      (res.unidades||[]).map(u => `
        <option value="${escapeHtml(u.value)}">${escapeHtml(u.label)}</option>
      `).join("");

    uSel.onchange = () => {
      applyOTUnidad_();
      renderNewOTTasks(false);
    };

    // ===== SECTORES (OT) =====
    // Primero: lo que mande backend
    let sectores = Array.isArray(res.sectores) ? res.sectores.filter(Boolean) : [];

    // Fallback: reconstruir desde tareas si vino vac√≠o
    if (sectores.length === 0 && (res.tareas||[]).length){
      const set = new Set((res.tareas||[]).map(t => (t.sector||"").toString().trim()).filter(Boolean));
      sectores = Array.from(set).sort((a,b)=>a.localeCompare(b,"es"));
    }

    fillSelect("nOTSector", sectores, "");
    if ($("nOTSector")?.options?.length) $("nOTSector").options[0].text = "Sector (OT): seleccionar";

    $("nOTSector").onchange = () => renderNewOTTasks(false);

    // ===== buscador =====
    $("nOTQ").oninput = () => renderNewOTTasks(false);

    // ===== limpiar =====
    $("nOTDominio").value = "";
    $("nOTSociedad").value = "";
    $("nOTDeposito").value = "";
    $("nOTSolicita").value = "";
    $("nOTDesc").value = "";
    $("nOTQ").value = "";

    // Render inicial (sin sector => NO muestra tareas)
    renderNewOTTasks(false);

  }).withFailureHandler(err=>{
    alert(err.message || String(err));
  }).getOTCreateOptions(TOKEN);

  // datalist de "Qui√©n solicita"
  google.script.run.withSuccessHandler(emp=>{
    if (emp?.ok) OT_EMPL = emp;

    const dl = document.getElementById("nOTSolicitaList");
    if (!dl) return;

    const list = (OT_EMPL?.empleados || []);
    dl.innerHTML = list.map(e =>
      `<option value="${escapeHtml(e.value + " ‚Äî " + e.nombre)}"></option>`
    ).join("");
  }).withFailureHandler(()=>{}).getEmpleadosOptions(TOKEN);
}


  function closeOTNew(){
    $("modalOTNew").style.display = "none";
  }

  function _norm(s){
  return (s ?? "")
    .toString()
    .trim()
    .toLowerCase()
    .replace(/\s+/g, " ");
}

function renderNewOTTasks(first){
  const secOT = ($("nOTSector")?.value || "").trim();
  const q = ($("nOTQ")?.value || "").toLowerCase().trim();

  // 1) Sin sector => NO HAY LISTA
  if (!secOT){
    $("nOTCount").textContent = `Eleg√≠ un Sector (OT) para habilitar la b√∫squeda.`;
    $("nOTTasks").innerHTML = `<div class="muted">‚¨ÖÔ∏è Primero seleccion√° Sector (OT).</div>`;
    return;
  }

  // 2) Sector elegido pero sin b√∫squeda => NO LISTAR
  if (!q){
    $("nOTCount").textContent = `Escrib√≠ para buscar tareas dentro de: ${secOT}`;
    $("nOTTasks").innerHTML = `<div class="muted">üîé Busc√° por c√≥digo o nombre‚Ä¶</div>`;
    return;
  }

  // 3) Filtra por sector + texto
  const list = (OT_CREATE.tareas||[]).filter(t=>{
    const blob = `${t.codigo||""} ${t.nombre||""}`.toLowerCase();
    const okQ = blob.includes(q);
    const okSec = (t.sector||"").toString().trim() === secOT;
    return okQ && okSec;
  });

  $("nOTCount").textContent = `${list.length} tarea(s) encontradas`;

  $("nOTTasks").innerHTML = list.map(t=>`
    <div class="taskRow">
      <input type="checkbox" class="nOTChk"
        data-cod="${escapeHtml(t.codigo)}"
        data-nom="${escapeHtml(t.nombre)}"
        data-sis="${escapeHtml(t.sistema||"")}"
        data-sub="${escapeHtml(t.subsistema||"")}"
        data-sec="${escapeHtml(t.sector||"")}"
        ${first ? "checked" : ""} />
      <div style="flex:1">
        <div><b>${escapeHtml(t.codigo)}</b> ‚Äî ${escapeHtml(t.nombre)}</div>
        <div class="muted" style="font-size:12px">${escapeHtml(t.sistema||"")} / ${escapeHtml(t.subsistema||"")} / ${escapeHtml(t.sector||"")}</div>
      </div>
    </div>
  `).join("") || `<div class="muted">Sin tareas para ese sector/b√∫squeda.</div>`;
}




  function setAllNewOT(state){
    document.querySelectorAll(".nOTChk").forEach(ch => ch.checked = !!state);
  }

  function saveOTNew(){
    $("nOTMsg").style.display = "none";

    const Interno = $("nOTInterno").value.trim();
    const Sector = $("nOTSector").value.trim();
    const SolicitaRaw = $("nOTSolicita").value.trim();
    const Descripcion = $("nOTDesc").value.trim();

    if (!Interno) return showNewOTErr("Interno es obligatorio.");
    if (!Sector) return showNewOTErr("Sector es obligatorio.");
    if (!SolicitaRaw) return showNewOTErr("Qui√©n solicita es obligatorio.");

    // Si viene "Legajo ‚Äî Nombre", guardamos solo legajo
    const Solicita = SolicitaRaw.includes("‚Äî") ? SolicitaRaw.split("‚Äî")[0].trim() : SolicitaRaw;

    const u = (OT_CREATE.unidades||[]).find(x => x.value === Interno) || {};
    const Dominio = (u.dominio || $("nOTDominio").value || "").toString();
    const Sociedad = (u.sociedad || $("nOTSociedad").value || "").toString();
    const Deposito = (u.deposito || $("nOTDeposito").value || "").toString();

    const tareas = Array.from(document.querySelectorAll(".nOTChk"))
      .filter(ch => ch.checked)
      .map(ch => ({
        codigo: ch.getAttribute("data-cod"),
        nombre: ch.getAttribute("data-nom"),
        sistema: ch.getAttribute("data-sis"),
        subsistema: ch.getAttribute("data-sub"),
        sector: ch.getAttribute("data-sec")
      }));

    if (tareas.length === 0) return showNewOTErr("Seleccion√° al menos 1 tarea.");

    setLoading("btnSaveOTNew", true);

    const payload = { Interno, Dominio, Sociedad, Deposito, Sector, Solicita, Descripcion, tareas };

    google.script.run.withSuccessHandler(res=>{
      setLoading("btnSaveOTNew", false);
      toast(`‚úÖ OT creada N¬∞ ${res.NroOT}`);
      closeOTNew();

      if (typeof searchOT_UI === "function"){
        $("otInterno").value = Interno;
        $("otNro").value = "";
        searchOT_UI();
      }
    }).withFailureHandler(err=>{
      setLoading("btnSaveOTNew", false);
      showNewOTErr(err.message || String(err));
    }).addOTCorrectiva(TOKEN, payload);
  }

  function showNewOTErr(msg){
    $("nOTMsg").textContent = msg;
    $("nOTMsg").style.display = "block";
  }

  render();
</script>
