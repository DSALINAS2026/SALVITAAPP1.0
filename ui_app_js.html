<script>
  const $ = (id) => document.getElementById(id);

  let TOKEN = localStorage.getItem("TOKEN") || "";
  let SESSION = null;

  let CACHE_ROWS = [];   // chasis
  let CACHE_MOV = [];    // movimientos
  let CACHE_TAREAS = []; // tareas

  let IS_ADMIN = false;
  let EDIT_ROW = null;

  let OPTIONS = { ejes: [], mapas: [], carrocerias: [] };
  let MOV_OPTS = { unidades: [], depositos: [] };
  let TAREAS_OPTS = { sistemas: [], subsistemas: [], sectores: [] };

  // movimiento state
  let MOV_TIPO = "";
  let MOV_LAST = 0;

  function render() {
    if (!TOKEN) return renderLogin();
    renderShell();
    pingSession();
  }

  function renderLogin() {
    $("app").innerHTML = `
      <div class="loginWrap">
        <div class="card">
          <div class="brand" style="margin:0 0 10px 0;color:var(--ink)">
            <div class="dot"></div><h1>Ingreso seguro</h1>
          </div>
          <p class="muted" style="margin-top:0">Acceso a gesti√≥n</p>

          <label class="muted"><b>Usuario</b></label>
          <input id="lUser" placeholder="Tu usuario" />
          <div style="height:8px"></div>
          <label class="muted"><b>Contrase√±a</b></label>
          <input id="lPass" type="password" placeholder="Tu contrase√±a" />

          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
            <button class="btn" onclick="doLogin()">Entrar</button>
          </div>

          <div id="lMsg" class="error" style="display:none"></div>
        </div>
      </div>
    `;
  }

  function renderShell() {
    $("app").innerHTML = `
      <div class="app">
        <aside class="sidebar">
          <div class="brand"><div class="dot"></div><h1>Mantenimiento</h1></div>
          <div class="nav">
            <button id="navCh" class="active" onclick="setActiveNav('ch'); showChasis();">
              <span>ChasisBD</span><small>Lista</small>
            </button>
            <button id="navMov" onclick="setActiveNav('mov'); showMovimientos();">
              <span>Movimientos</span><small>Ingreso/Egreso</small>
            </button>
            <button id="navTar" onclick="setActiveNav('tar'); showTareas();">
              <span>Maestro Tareas</span><small>Alta/Buscar</small>
            </button>
            <button id="navOT" onclick="setActiveNav('ot'); showOT();">
             <span>OT</span><small>Correct/Prev</small>
            </button>
            <button id="navHP" onclick="setActiveNav('hp'); showHP();">
              <span>Hojas Preventivas</span><small>Buscar / Crear</small>
            </button>
            <button id="navEU" onclick="setActiveNav('estadounidad'); showEstadoUnidad();">
              <span>Estado Unidad</span><small>Preventivos</small>
            </button>


          </div>
          <div style="margin-top:14px;opacity:.95">
            <button class="btn secondary" style="width:100%" onclick="doLogout()">Cerrar sesi√≥n</button>
          </div>
        </aside>

        <main class="main">
          <div class="topbar">
            <div class="clock" id="clock">--:--:--</div>
            <div class="userbox">
              <div class="chip"><b>Usuario:</b> <span id="uName">-</span></div>
              <div class="chip"><b>Rol:</b> <span id="uRol">-</span></div>
            </div>
          </div>

          <div id="view"></div>
        </main>
      </div>
    `;
    startClock();
  }

  function setActiveNav(which){
    $("navCh")?.classList.remove("active");
    $("navMov")?.classList.remove("active");
    $("navTar")?.classList.remove("active");
    $("navOT")?.classList.remove("active");
    $("navHP")?.classList.remove("active");
    $("navEU")?.classList.remove("active");
    if (which === "ch") $("navCh")?.classList.add("active");
    if (which === "mov") $("navMov")?.classList.add("active");
    if (which === "tar") $("navTar")?.classList.add("active");
    if (which === "ot") $("navOT")?.classList.add("active");
    if (which === "hp") $("navHP")?.classList.add("active");
    if (which === "estadounidad") $("navEU")?.classList.add("active");

  }

  function startClock() {
    const tick = () => {
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      $("clock").textContent = `${hh}:${mm}:${ss}`;
    };
    tick();
    setInterval(tick, 1000);
  }

  function pingSession() {
    google.script.run.withSuccessHandler(res => {
      if (!res || !res.ok) {
        TOKEN = ""; localStorage.removeItem("TOKEN");
        SESSION = null;
        return render();
      }
      SESSION = res.user;
      IS_ADMIN = (SESSION.r === "ADMIN" || SESSION.r === "ADMINISTRADOR");
      $("uName").textContent = SESSION.n || SESSION.u;
      $("uRol").textContent = SESSION.r || "-";

      loadOptions(() =>
        loadMovOptions(() =>
          loadTareasOptions(() =>
            showChasis()
          )
        )
      );
    }).withFailureHandler(() => {
      TOKEN = ""; localStorage.removeItem("TOKEN");
      render();
    }).getSession(TOKEN);
  }

  function doLogin() {
    const u = $("lUser").value.trim();
    const p = $("lPass").value;
    $("lMsg").style.display = "none";

    google.script.run.withSuccessHandler(res => {
      if (!res.ok) {
        $("lMsg").textContent = res.msg || "Error";
        $("lMsg").style.display = "block";
        return;
      }
      TOKEN = res.token;
      localStorage.setItem("TOKEN", TOKEN);
      render();
    }).withFailureHandler(err => {
      $("lMsg").textContent = err.message || String(err);
      $("lMsg").style.display = "block";
    }).login(u, p);
  }

  function doLogout() {
    const t = TOKEN;
    TOKEN = ""; localStorage.removeItem("TOKEN");
    google.script.run.logout(t);
    render();
  }

  // ===== selects Chasis =====
  function loadOptions(cb){
    google.script.run.withSuccessHandler(res => {
      if (res && res.ok) OPTIONS = res;
      if (cb) cb();
    }).withFailureHandler(() => cb && cb()).getSelectOptions(TOKEN);
  }

  // ===== selects Mov =====
  function loadMovOptions(cb){
    google.script.run.withSuccessHandler(res => {
      if (res && res.ok) MOV_OPTS = res;
      if (cb) cb();
    }).withFailureHandler(() => cb && cb()).getMovSelectOptions(TOKEN);
  }

  // ===== selects Tareas =====
  function loadTareasOptions(cb){
    google.script.run.withSuccessHandler(res => {
      if (res && res.ok) TAREAS_OPTS = res;
      if (cb) cb();
    }).withFailureHandler(() => cb && cb()).getTareasSelectOptions(TOKEN);
  }

  function fillSelect(id, arr, currentValue, firstLabel){
    const el = $(id);
    if (!el) return;

    const cur = (currentValue ?? "").toString().trim();
    const list = (arr || []).slice();

    const first = (firstLabel ?? "(seleccionar)").toString();
    let html = `<option value="">${escapeHtml(first)}</option>`;

    list.forEach(v => {
      const sel = (v === cur) ? "selected" : "";
      html += `<option ${sel} value="${escapeHtml(v)}">${escapeHtml(v)}</option>`;
    });

    if (cur && !list.includes(cur)) {
      html = `<option selected value="${escapeHtml(cur)}">${escapeHtml(cur)}</option>` + html;
    }

    el.innerHTML = html;
  }

  function fillUnidadSelect(){
    const el = $("mUnidadSel");
    if (!el) return;
    let html = `<option value="">(seleccionar unidad)</option>`;
    (MOV_OPTS.unidades || []).forEach(u=>{
      html += `<option value="${escapeHtml(u.value)}">${escapeHtml(u.label)}</option>`;
    });
    el.innerHTML = html;
  }

  function fillDepositoSelect(current){
    const el = $("mDepositoSel");
    if (!el) return;
    const cur = (current ?? "").toString();
    let html = `<option value="">(seleccionar dep√≥sito)</option>`;
    (MOV_OPTS.depositos || []).forEach(d=>{
      const sel = d === cur ? "selected" : "";
      html += `<option ${sel} value="${escapeHtml(d)}">${escapeHtml(d)}</option>`;
    });
    html += `<option value="__OTRO__">Otro‚Ä¶</option>`;
    el.innerHTML = html;
  }

  // ===================== CHASIS VIEW =====================
  function showChasis() {
    setActiveNav("ch");
    $("view").innerHTML = `
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
          <div>
            <div style="font-size:18px;font-weight:1000">ChasisBD</div>
            <div class="muted">Visualiz√°, busc√° y (si sos ADMIN) gestion√° estados.</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <button class="btn" onclick="openAdd()" id="btnAdd" style="display:none">+ Agregar chasis</button>
            <button class="btn secondary" onclick="loadChasis()">Actualizar</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px" id="kpis"></div>

        <div class="controls">
          <input id="q" placeholder="Buscar: interno / dominio / sociedad..." oninput="applyFilter()" />
          <select id="f" onchange="applyFilter()">
            <option value="">Estado: todos</option>
            <option value="activo">activo</option>
            <option value="inactivo">inactivo</option>
            <option value="baja">baja</option>
          </select>
          <div class="muted" id="count"></div>
        </div>

        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Interno</th>
                <th>Dominio</th>
                <th>Sociedad</th>
                <th>Dep√≥sito</th>
                <th>Tipo</th>
                <th>Km</th>
                <th>Estado</th>
                <th id="thAcc" style="display:none">Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    `;
    loadChasis();
  }

  function loadChasis() {
    google.script.run.withSuccessHandler(res => {
      IS_ADMIN = !!res.isAdmin;
      $("btnAdd").style.display = IS_ADMIN ? "inline-flex" : "none";
      $("thAcc").style.display = IS_ADMIN ? "table-cell" : "none";

      const s = res.summary || {total:0,activo:0,inactivo:0,baja:0};
      $("kpis").innerHTML = `
        <div class="card kpi" style="padding:12px"><div class="n">${s.total}</div><div class="t">Unidades (total)</div></div>
        <div class="card kpi" style="padding:12px"><div class="n">${s.activo}</div><div class="t">Activas</div></div>
        <div class="card kpi" style="padding:12px"><div class="n">${s.inactivo}</div><div class="t">Inactivas</div></div>
        <div class="card kpi" style="padding:12px"><div class="n">${s.baja}</div><div class="t">Baja</div></div>
      `;

      CACHE_ROWS = res.rows || [];
      applyFilter();
    }).withFailureHandler(err => {
      $("tbody").innerHTML = `<tr><td colspan="8" class="error">${err.message || err}</td></tr>`;
    }).listChasis(TOKEN);
  }

  function applyFilter() {
    const q = ($("q")?.value || "").toLowerCase().trim();
    const f = ($("f")?.value || "").toLowerCase().trim();

    const rows = CACHE_ROWS.filter(r => {
      const blob = `${r.Interno} ${r.Dominio} ${r.Sociedad} ${r.Deposito} ${r.Tipo}`.toLowerCase();
      const okQ = !q || blob.includes(q);
      const okF = !f || (r.Estado === f);
      return okQ && okF;
    });

    $("count").textContent = `${rows.length} resultado(s)`;

    $("tbody").innerHTML = rows.map(r => {
      const est = (r.Estado || "activo");
      const estadoBadge = `<span class="estado ${est}"><span class="dot2"></span>${est}</span>`;

      const acc = IS_ADMIN ? `
        <td>
          <div class="actions">
            <button class="mini" onclick="quickEdit(${r._row})">Editar</button>
            <button class="mini" onclick="setEstado(${r._row},'activo')">Activo</button>
            <button class="mini" onclick="setEstado(${r._row},'inactivo')">Inactivo</button>
            <button class="mini" onclick="setEstado(${r._row},'baja')">Baja</button>
          </div>
        </td>` : ``;

      return `
        <tr>
          <td><b>${escapeHtml(r.Interno)}</b></td>
          <td>${escapeHtml(r.Dominio)}</td>
          <td>${escapeHtml(r.Sociedad)}</td>
          <td>${escapeHtml(r.Deposito)}</td>
          <td>${escapeHtml(r.Tipo)}</td>
          <td>${escapeHtml(r.KmRecorridos)}</td>
          <td>${estadoBadge}</td>
          ${IS_ADMIN ? acc : ""}
        </tr>
      `;
    }).join("") || `<tr><td colspan="${IS_ADMIN?8:7}" class="muted">Sin resultados.</td></tr>`;
  }

  function setEstado(row, estado) {
    google.script.run.withSuccessHandler(() => {
      toast("‚úÖ Estado actualizado");
      loadChasis();
      loadMovOptions();
    }).withFailureHandler(err => alert(err.message || err))
      .setChasisEstado(TOKEN, row, estado);
  }

  function quickEdit(row) {
    if (!IS_ADMIN) return alert("Solo administradores pueden editar.");
    const r = CACHE_ROWS.find(x => x._row === row);
    if (!r) return;

    EDIT_ROW = row;
    $("editMsg").style.display = "none";

    $("eInterno").value = r.Interno || "";
    $("eDominio").value = r.Dominio || "";
    $("eSociedad").value = r.Sociedad || "";
    $("eDeposito").value = r.Deposito || "";
    $("eTipo").value = r.Tipo || "";
    $("eKm").value = r.KmRecorridos || "";

    $("eCapacidad").value = r.CapacidadCarga || "";
    $("eNroChasis").value = r["Nro. Chasis"] || "";
    $("eMarca").value = r.Marca || "";
    $("eModelo").value = r.Modelo || "";
    $("eMotor").value = r.Motor || "";
    $("eNroMotor").value = r["Nro Motor"] || "";

    $("eAnio").value = r["A√±o"] || "";

    fillSelect("eEje", OPTIONS.ejes, r.Eje || "");
    fillSelect("eMapa", OPTIONS.mapas, r["Mapa Cubierta"] || "");
    fillSelect("eCarroceria", OPTIONS.carrocerias, r.Carroceria || "");

    $("eEstado").value = (r.Estado || "activo").toLowerCase();

    $("modalEdit").style.display = "flex";
  }

  function closeEdit(){ $("modalEdit").style.display = "none"; EDIT_ROW = null; }

  function showEditErr(msg){
    if (!msg){ $("editMsg").style.display = "none"; return; }
    $("editMsg").textContent = msg;
    $("editMsg").style.display = "block";
  }

  function saveEdit(){
    if (!EDIT_ROW) return;

    const Interno = $("eInterno").value.trim();
    const Dominio = $("eDominio").value.trim();
    if (!Interno) return showEditErr("Interno es obligatorio.");
    if (!Dominio) return showEditErr("Dominio/Patente es obligatorio.");
    showEditErr("");

    setLoading("btnSaveEdit", true);

    const fields = {
      Interno,
      Dominio,
      Sociedad: $("eSociedad").value.trim(),
      Deposito: $("eDeposito").value.trim(),
      Tipo: $("eTipo").value.trim(),
      KmRecorridos: $("eKm").value.trim() || "0",
      CapacidadCarga: $("eCapacidad").value.trim(),
      "Nro. Chasis": $("eNroChasis").value.trim(),
      Marca: $("eMarca").value.trim(),
      Modelo: $("eModelo").value.trim(),
      Motor: $("eMotor").value.trim(),
      "Nro Motor": $("eNroMotor").value.trim(),
      "A√±o": $("eAnio").value.trim(),
      Eje: $("eEje").value,
      "Mapa Cubierta": $("eMapa").value,
      Carroceria: $("eCarroceria").value,
      Estado: $("eEstado").value
    };

    google.script.run.withSuccessHandler(() => {
      setLoading("btnSaveEdit", false);
      closeEdit();
      toast("‚úÖ Cambios guardados");
      loadChasis();
      loadMovOptions();
    }).withFailureHandler(err => {
      setLoading("btnSaveEdit", false);
      showEditErr(err.message || String(err));
    }).updateChasisFields(TOKEN, EDIT_ROW, fields);
  }

  function openAdd() {
    if (!IS_ADMIN) return alert("Solo administradores pueden agregar.");
    $("addMsg").style.display = "none";
    $("modalAdd").style.display = "flex";

    [
      "fInterno","fDominio","fSociedad","fDeposito","fTipo","fKm",
      "fCapacidad","fNroChasis","fMarca","fModelo","fMotor","fNroMotor","fAnio"
    ].forEach(id => $(id).value = "");

    $("fEstado").value = "activo";
    fillSelect("fEje", OPTIONS.ejes, "");
    fillSelect("fMapa", OPTIONS.mapas, "");
    fillSelect("fCarroceria", OPTIONS.carrocerias, "");
  }

  function closeAdd(){ $("modalAdd").style.display = "none"; }

  function saveAdd() {
    $("addMsg").style.display = "none";
    setLoading("btnSaveAdd", true);

    const payload = {
      Interno: $("fInterno").value.trim(),
      Dominio: $("fDominio").value.trim(),
      Sociedad: $("fSociedad").value.trim(),
      Deposito: $("fDeposito").value.trim(),
      Tipo: $("fTipo").value.trim(),
      KmRecorridos: $("fKm").value.trim() || "0",
      CapacidadCarga: $("fCapacidad").value.trim(),
      "Nro. Chasis": $("fNroChasis").value.trim(),
      Marca: $("fMarca").value.trim(),
      Modelo: $("fModelo").value.trim(),
      Motor: $("fMotor").value.trim(),
      "Nro Motor": $("fNroMotor").value.trim(),
      "A√±o": $("fAnio").value.trim(),
      Eje: $("fEje").value,
      "Mapa Cubierta": $("fMapa").value,
      Carroceria: $("fCarroceria").value,
      Estado: $("fEstado").value
    };

    google.script.run.withSuccessHandler(() => {
      setLoading("btnSaveAdd", false);
      closeAdd();
      toast("‚úÖ Chasis guardado");
      loadChasis();
      loadMovOptions();
    }).withFailureHandler(err => {
      setLoading("btnSaveAdd", false);
      $("addMsg").textContent = err.message || String(err);
      $("addMsg").style.display = "block";
    }).addChasis(TOKEN, payload);
  }

  // ===================== MOVIMIENTOS VIEW (PRO) =====================
  function showMovimientos(){
    setActiveNav("mov");
    $("view").innerHTML = `
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
          <div>
            <div style="font-size:18px;font-weight:1000">MovimientoUnidad</div>
            <div class="muted">B√∫squeda por interno + rango de fechas + filtros pro.</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <button class="btn" onclick="openMov()">+ Nuevo movimiento</button>
            <button class="btn secondary" onclick="loadMovimientos()">Actualizar</button>
          </div>
        </div>

        <div class="controls">
          <input id="mq" placeholder="Buscar interno..." oninput="applyMovFilter()" />
          <select id="mt" onchange="applyMovFilter()">
            <option value="">Tipo: todos</option>
            <option value="ingreso">ingreso</option>
            <option value="egreso">egreso</option>
          </select>

          <select id="mdepSel" onchange="applyMovFilter()">
            <option value="">Dep√≥sito: todos</option>
          </select>

          <input id="mfrom" type="date" onchange="applyMovFilter()" />
          <input id="mto" type="date" onchange="applyMovFilter()" />

          <div class="muted" id="mcount"></div>
        </div>

        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Fecha/Hora</th>
                <th>Unidad</th>
                <th>Tipo</th>
                <th>Dep√≥sito</th>
                <th>√öltimo</th>
                <th>Od√≥metro</th>
                <th>Km</th>
                <th>Obs.</th>
              </tr>
            </thead>
            <tbody id="mtbody"></tbody>
          </table>
        </div>
      </div>
    `;

    fillSelect("mdepSel", MOV_OPTS.depositos || [], "");
    if ($("mdepSel")?.options?.length) $("mdepSel").options[0].text = "Dep√≥sito: todos";

    loadMovimientos();
  }

  function loadMovimientos(){
    google.script.run.withSuccessHandler(res => {
      CACHE_MOV = res.rows || [];
      applyMovFilter();
    }).withFailureHandler(err => {
      $("mtbody").innerHTML = `<tr><td colspan="8" class="error">${err.message || err}</td></tr>`;
    }).listMovimientos(TOKEN);
  }

  function applyMovFilter(){
    const q = ($("mq")?.value || "").toLowerCase().trim();
    const tipo = ($("mt")?.value || "").toLowerCase().trim();
    const dep = ($("mdepSel")?.value || "").toLowerCase().trim();

    const from = $("mfrom")?.value ? new Date($("mfrom").value + "T00:00:00").getTime() : null;
    const to = $("mto")?.value ? new Date($("mto").value + "T23:59:59").getTime() : null;

    const rows = CACHE_MOV.filter(r => {
      const okQ = !q || (r.Unidad || "").toLowerCase().includes(q);
      const okT = !tipo || (r.Tipo || "").toLowerCase() === tipo;
      const okD = !dep || (r.Deposito || "").toLowerCase() === dep;

      const fm = r.FechaMovMs ?? null;
      const okF = (!from || (fm !== null && fm >= from)) && (!to || (fm !== null && fm <= to));

      return okQ && okT && okD && okF;
    });

    $("mcount").textContent = `${rows.length} movimiento(s)`;

    $("mtbody").innerHTML = rows.map(r => `
      <tr>
        <td><b>${fmtDate(r.FechaMovMs)} ${escapeHtml(r.HoraMov || "")}</b></td>
        <td><b>${escapeHtml(r.Unidad)}</b></td>
        <td>${escapeHtml(r.Tipo)}</td>
        <td>${escapeHtml(r.Deposito)}</td>
        <td>${escapeHtml(String(r.UltimoOdometro ?? 0))}</td>
        <td>${escapeHtml(String(r.Odometro ?? 0))}</td>
        <td>${escapeHtml(String(r.KmRecorridos ?? 0))}</td>
        <td>${escapeHtml((r.Observacion || "").slice(0,40))}</td>
      </tr>
    `).join("") || `<tr><td colspan="8" class="muted">Sin resultados.</td></tr>`;
  }

  function setTipoMov(t){
    MOV_TIPO = t;
    $("tIngreso")?.classList.toggle("active", t === "ingreso");
    $("tEgreso")?.classList.toggle("active", t === "egreso");
    validateMovInputs();
  }

  function openMov(){
    $("movMsg").style.display = "none";
    $("modalMov").style.display = "flex";

    MOV_TIPO = "";
    MOV_LAST = 0;

    setTipoMov("");
    $("mUlt").value = "";
    $("mOdo").value = "";
    $("mKm").value = "";
    $("mObs").value = "";
    $("mDepositoOtherWrap").style.display = "none";
    $("mDepositoOther").value = "";

    const now = new Date();
    $("mFecha").value = now.toISOString().slice(0,10);
    $("mHora").value = now.toTimeString().slice(0,5);

    fillUnidadSelect();
    fillDepositoSelect("");

    $("mDepositoSel").onchange = () => {
      const v = $("mDepositoSel").value;
      const show = (v === "__OTRO__");
      $("mDepositoOtherWrap").style.display = show ? "block" : "none";
      if (!show) $("mDepositoOther").value = "";
      validateMovInputs();
    };

    $("mUnidadSel").onchange = () => {
      const unidad = $("mUnidadSel").value.trim();
      MOV_LAST = 0;
      $("mUlt").value = "";
      $("mKm").value = "";
      $("mOdo").value = "";
      validateMovInputs();

      if (!unidad) return;

      google.script.run.withSuccessHandler(res => {
        const last = Number(res?.last || 0);
        MOV_LAST = last;
        $("mUlt").value = String(last);
        calcKmLive();
        validateMovInputs();

        const u = (MOV_OPTS.unidades || []).find(x => x.value === unidad);
        if (u && u.deposito) {
          fillDepositoSelect(u.deposito);
        }
      }).withFailureHandler(err => {
        showMovErr(err.message || String(err));
      }).getUltimoOdometer(TOKEN, unidad);
    };

    $("mOdo").oninput = () => {
      calcKmLive();
      validateMovInputs();
    };

    $("mFecha").onchange = validateMovInputs;
    $("mHora").onchange = validateMovInputs;

    validateMovInputs();
  }

  function closeMov(){ $("modalMov").style.display = "none"; }

  function calcKmLive(){
    const odo = parseInt(($("mOdo").value || "").toString().replace(/[^\d]/g,""), 10);
    if (!isFinite(odo)) { $("mKm").value = ""; return; }
    const km = odo - (MOV_LAST || 0);
    $("mKm").value = String(isFinite(km) ? km : "");
  }

  function validateMovInputs(){
    const unidad = $("mUnidadSel").value.trim();
    const fecha = $("mFecha").value;
    const hora = $("mHora").value;

    let dep = $("mDepositoSel").value.trim();
    if (dep === "__OTRO__") dep = $("mDepositoOther").value.trim();

    const odo = parseInt(($("mOdo").value || "").toString().replace(/[^\d]/g,""), 10);

    let err = "";

    if (!unidad) err = "Unidad es obligatoria.";
    else if (!MOV_TIPO) err = "Eleg√≠ Tipo: Ingreso o Egreso.";
    else if (!fecha) err = "Fecha es obligatoria.";
    else if (!hora) err = "Hora es obligatoria.";
    else if (!dep) err = "Dep√≥sito es obligatorio.";
    else if (!isFinite(odo) || odo <= 0) err = "Od√≥metro inv√°lido.";
    else if (isFinite(MOV_LAST) && odo < MOV_LAST) err = `Od√≥metro no puede ser menor al √∫ltimo (${MOV_LAST}).`;

    const btn = $("btnSaveMov");
    if (err) {
      btn.style.pointerEvents = "none";
      btn.style.opacity = "0.7";
      $("mOdoHint").innerHTML = `<span class="error">${escapeHtml(err)}</span>`;
    } else {
      btn.style.pointerEvents = "";
      btn.style.opacity = "";
      $("mOdoHint").innerHTML = `Ok. Km se calcula autom√°ticamente.`;
    }
  }

  function showMovErr(msg){
    $("movMsg").textContent = msg;
    $("movMsg").style.display = "block";
  }

  function saveMov(){
    $("movMsg").style.display = "none";

    const Unidad = $("mUnidadSel").value.trim();
    const FechaISO = $("mFecha").value;
    const HoraMov = $("mHora").value;

    let Deposito = $("mDepositoSel").value.trim();
    if (Deposito === "__OTRO__") Deposito = $("mDepositoOther").value.trim();

    const Odometro = parseInt(($("mOdo").value || "").toString().replace(/[^\d]/g,""), 10);
    const Observacion = $("mObs").value.trim();

    if (!Unidad) return showMovErr("Unidad es obligatoria.");
    if (!MOV_TIPO) return showMovErr("Eleg√≠ Tipo: Ingreso o Egreso.");
    if (!FechaISO) return showMovErr("Fecha es obligatoria.");
    if (!HoraMov) return showMovErr("Hora es obligatoria.");
    if (!Deposito) return showMovErr("Dep√≥sito es obligatorio.");
    if (!isFinite(Odometro) || Odometro <= 0) return showMovErr("Od√≥metro inv√°lido.");
    if (Odometro < (MOV_LAST || 0)) return showMovErr(`Od√≥metro no puede ser menor al √∫ltimo (${MOV_LAST}).`);

    setLoading("btnSaveMov", true);

    google.script.run.withSuccessHandler(() => {
      setLoading("btnSaveMov", false);
      toast("‚úÖ Movimiento guardado");
      closeMov();
      loadMovimientos();
      loadChasis();
      loadMovOptions();
    }).withFailureHandler(err => {
      setLoading("btnSaveMov", false);
      showMovErr(err.message || String(err));
    }).addMovimiento(TOKEN, { Unidad, Tipo: MOV_TIPO, FechaISO, HoraMov, Odometro, Deposito, Observacion });
  }

  // ===================== MAESTRO TAREAS =====================
  function showTareas(){
    setActiveNav("tar");
    $("view").innerHTML = `
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
          <div>
            <div style="font-size:18px;font-weight:1000">MaestroTareas</div>
            <div class="muted">Busc√° por c√≥digo/nombre y filtr√° por sistema, subsistema y sector.</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <button class="btn" onclick="openTarea()">+ Agregar tarea</button>
            <button class="btn secondary" onclick="loadTareas()">Actualizar</button>
          </div>
        </div>

        <div class="controls">
        <input id="tq" placeholder="Buscar: c√≥digo o nombre..." oninput="applyTareasFilter()" />

         <select id="tsis" onchange="applyTareasFilter()">
           <option value="">Sistema: todos</option>
           </select>

           <select id="tsubf" onchange="applyTareasFilter()">
            <option value="">Subsistema: todos</option>
           </select>

           <select id="tsecf" onchange="applyTareasFilter()">
           <option value="">Sector: todos</option>
             </select>

            <label class="muted" style="display:flex;align-items:center;gap:8px;font-weight:900">
           <input id="tShowDel" type="checkbox" onchange="toggleVerEliminados()" style="min-width:auto;width:auto"/>
            Ver eliminados
           </label>

            <button class="btn secondary" onclick="resetTareasFilters()">Limpiar</button>

             <div class="muted" id="tcount"></div>
              </div>

        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Nombre</th>
                <th>Sistema</th>
                <th>Subsistema</th>
                <th>Sector</th>
                <th style="width:120px">Acci√≥n</th>
              </tr>
            </thead>
            <tbody id="ttbody"></tbody>
          </table>
        </div>
      </div>
    `;

    loadTareasOptions(() => {
      fillTareasFilterSelects_();
      loadTareas();
    });
  }

  function fillTareasFilterSelects_(){
    const sis = $("tsis"), sub = $("tsubf"), sec = $("tsecf");
    if (!sis || !sub || !sec) return;

    sis.innerHTML = `<option value="">Sistema: todos</option>` + (TAREAS_OPTS.sistemas||[]).map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join("");
    sub.innerHTML = `<option value="">Subsistema: todos</option>` + (TAREAS_OPTS.subsistemas||[]).map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join("");
    sec.innerHTML = `<option value="">Sector: todos</option>` + (TAREAS_OPTS.sectores||[]).map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join("");
  }

  function loadTareas(){
    const showDel = !!$("tShowDel")?.checked;
    const fn = showDel ? "listTareasIncluyendoEliminadas" : "listTareas";

    google.script.run.withSuccessHandler(res => {
      CACHE_TAREAS = res.rows || [];
      applyTareasFilter();
    }).withFailureHandler(err => {
      $("ttbody").innerHTML = `<tr><td colspan="6" class="error">${err.message || err}</td></tr>`;
    })[fn](TOKEN);
  }

  function applyTareasFilter(){
    const q = ($("tq")?.value || "").toLowerCase().trim();
    const sis = ($("tsis")?.value || "").toLowerCase().trim();
    const sub = ($("tsubf")?.value || "").toLowerCase().trim();
    const sec = ($("tsecf")?.value || "").toLowerCase().trim();

    const showDel = !!$("tShowDel")?.checked;

    const rows = CACHE_TAREAS.filter(r => {
      if (!showDel && (r.borrado === true || String(r.borrado).toLowerCase() === "true")) return false;

      const blob = `${r.codigo} ${r.nombre}`.toLowerCase();
      const okQ = !q || blob.includes(q);
      const okS = !sis || (r.sistema||"").toLowerCase() === sis;
      const okSub = !sub || (r.subsistema||"").toLowerCase() === sub;
      const okSec = !sec || (r.sector||"").toLowerCase() === sec;
      return okQ && okS && okSub && okSec;
    });

    $("tcount").textContent = `${rows.length} tarea(s)`;

    $("ttbody").innerHTML = rows.map(r => `
      <tr>
        <td><b>${escapeHtml(r.codigo)}</b></td>
        <td>${escapeHtml(r.nombre)}</td>
        <td>${escapeHtml(r.sistema)}</td>
        <td>${escapeHtml(r.subsistema)}</td>
        <td>${escapeHtml(r.sector)}</td>
        <td>
          ${ (r.borrado === true || String(r.borrado).toLowerCase() === "true")
              ? `<span class="muted"><b>Eliminada</b></span>`
              : `<button class="mini" onclick="confirmBorrarTarea(${r._row})">Borrar</button>` }
        </td>
      </tr>
    `).join("") || `<tr><td colspan="6" class="muted">Sin resultados.</td></tr>`;
  }

  function toggleVerEliminados(){
    loadTareas();
  }

  function resetTareasFilters(){
    if ($("tq")) $("tq").value = "";
    if ($("tsis")) $("tsis").value = "";
    if ($("tsubf")) $("tsubf").value = "";
    if ($("tsecf")) $("tsecf").value = "";
    applyTareasFilter();
  }

  function openTarea(){
    if (!$("modalTarea")) return alert("No se encontr√≥ modalTarea. Revis√° ui_modals.html.");

    $("tMsg").style.display = "none";
    $("modalTarea").style.display = "flex";

    $("tcodigo").value = "";
    $("tnombre").value = "";

    $("tsistema").innerHTML = `<option value="">(seleccionar)</option>` + (TAREAS_OPTS.sistemas||[]).map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join("");
    $("tsubsistema").innerHTML = `<option value="">(seleccionar)</option>` + (TAREAS_OPTS.subsistemas||[]).map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join("");
    $("tsector").innerHTML = `<option value="">(seleccionar)</option>` + (TAREAS_OPTS.sectores||[]).map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join("");
  }

  function closeTarea(){ $("modalTarea").style.display = "none"; }

  function showTareaErr(msg){
    $("tMsg").textContent = msg;
    $("tMsg").style.display = "block";
  }

  function saveTarea(){
    $("tMsg").style.display = "none";

    const codigo = $("tcodigo").value.trim();
    const nombre = $("tnombre").value.trim();
    const sistema = $("tsistema").value.trim();
    const subsistema = $("tsubsistema").value.trim();
    const sector = $("tsector").value.trim();

    if (!codigo) return showTareaErr("C√≥digo es obligatorio.");
    if (!nombre) return showTareaErr("Nombre es obligatorio.");
    if (!sistema) return showTareaErr("Sistema es obligatorio.");
    if (!subsistema) return showTareaErr("Subsistema es obligatorio.");
    if (!sector) return showTareaErr("Sector es obligatorio.");

    setLoading("btnSaveTarea", true);

    google.script.run.withSuccessHandler(() => {
      setLoading("btnSaveTarea", false);
      toast("‚úÖ Tarea guardada");
      closeTarea();
      loadTareasOptions(()=>{});
      loadTareas();
    }).withFailureHandler(err => {
      setLoading("btnSaveTarea", false);
      showTareaErr(err.message || String(err));
    }).addTarea(TOKEN, { codigo, nombre, sistema, subsistema, sector });
  }

  let TAREA_DEL_ROW = null;

  function confirmBorrarTarea(row){
    const r = CACHE_TAREAS.find(x => x._row === row);
    if (!r) return alert("No se encontr√≥ la tarea.");

    TAREA_DEL_ROW = row;

    $("cDelCod").textContent = r.codigo || "-";
    $("cDelNom").textContent = r.nombre || "-";
    $("cDelMsg").style.display = "none";

    $("modalConfirmTarea").style.display = "flex";
  }

  function closeConfirmTarea(){
    $("modalConfirmTarea").style.display = "none";
    TAREA_DEL_ROW = null;
  }

  function doBorrarTarea(){
    if (!TAREA_DEL_ROW) return;

    $("cDelMsg").style.display = "none";
    setLoading("btnConfirmDelTarea", true);

    google.script.run.withSuccessHandler(() => {
      setLoading("btnConfirmDelTarea", false);
      toast("üóëÔ∏è Tarea eliminada");
      closeConfirmTarea();
      loadTareasOptions(()=>{});
      loadTareas();
    }).withFailureHandler(err => {
      setLoading("btnConfirmDelTarea", false);
      $("cDelMsg").textContent = err.message || String(err);
      $("cDelMsg").style.display = "block";
    }).borrarTarea(TOKEN, TAREA_DEL_ROW);
  }

  // ===================== UTIL =====================
  function setLoading(btnId, isLoading){
    const b = $(btnId);
    if (!b) return;
    b.classList.toggle("loading", !!isLoading);
  }

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 1500);
  }

  function escapeHtml(s){
    s = (s ?? "").toString();
    return s.replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function fmtDate(ms){
    if (!ms) return "";
    const d = new Date(ms);
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    return `${dd}-${mm}-${yy}`;
  }

  function fmtOT(n){
    const s = String(n ?? "").replace(/[^\d]/g,"");
    if (!s) return "";
    return s.padStart(6,"0");
  }

  window.addEventListener("click", (e) => {
    if (e.target === $("modalAdd")) closeAdd();
    if (e.target === $("modalEdit")) closeEdit();
    if (e.target === $("modalMov")) closeMov();
    if (e.target === $("modalTarea")) closeTarea();
    if (e.target === $("modalConfirmTarea")) closeConfirmTarea();
    if (e.target === $("modalOTView")) closeOTView();
    if (e.target === $("modalOTConfirm")) closeOTConfirm();
    if (e.target === $("modalOTNew")) closeOTNew();
    if (e.target === $("modalOTNewPrev")) closeOTNewPrev();
    if (e.target === $("modalHPNew")) closeHPNew();
    if (e.target === $("modalHPView")) closeHPView();
    if (e.target === $("modalEUReprog")) closeEUReprog();


  });


  // ===================== ESTADO UNIDAD =====================
  let EU_LAST = { interno:"", data:null };

  function showEstadoUnidad(){
    setActiveNav("estadounidad");

    $("view").innerHTML = `
      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-size:18px;font-weight:1000">Estado Unidad</div>
            <div class="muted">Busc√° por Interno para ver el estado de preventivos.</div>
          </div>
        </div>

        <div class="euTopRow" style="margin-top:12px">
          <div>
            <label class="muted"><b>Interno</b></label>
            <input id="euInterno" placeholder="Ej: 1234" inputmode="numeric" />
          </div>
          <div>
            <button class="btn" onclick="buscarEstadoUnidad_UI()">Buscar</button>
            <button class="btn secondary" onclick="limpiarEstadoUnidad_UI()">Limpiar</button>
          </div>
        </div>

        <div id="euMsg" class="error" style="display:none;margin-top:10px"></div>
      </div>

      <div id="euOut"></div>
    `;

    // no mostrar nada hasta buscar
    $("euOut").innerHTML = "";
  }

  function limpiarEstadoUnidad_UI(){
    $("euMsg").style.display = "none";
    if ($("euInterno")) $("euInterno").value = "";
    $("euOut").innerHTML = "";
    EU_LAST = { interno:"", data:null };
  }

  function buscarEstadoUnidad_UI(){
    const interno = ($("euInterno").value || "").trim();
    $("euMsg").style.display = "none";

    if (!interno) {
      return showEUError("Interno es obligatorio.");
    }

    $("euOut").innerHTML = `<div class="card"><div class="muted">Cargando‚Ä¶</div></div>`;

    google.script.run.withSuccessHandler(res=>{
      if (!res?.ok) return showEUError("No se pudo obtener datos.");

      EU_LAST = { interno, data:res };

      renderEU(res);

    }).withFailureHandler(err=>{
      showEUError(err.message || String(err));
    }).getEstadoUnidad(TOKEN, interno);
  }

  function showEUError(msg){
    $("euMsg").style.display = "block";
    $("euMsg").innerText = msg;
    $("euOut").innerHTML = "";
  }

  function renderEU(res){
    const u = res.unidad || {};
    const rows = res.rows || [];
    const next = res.nextDue || null;

    const nextTxt = next ? `${escapeHtml(next.NombreHP || "")} ‚Äî vence: <b>${escapeHtml(String(next.Vence||"-"))}</b>` : "‚Äî";

    const unitCard = `
      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-size:16px;font-weight:1000">Unidad ${escapeHtml(u.Interno||"")}</div>
            <div class="muted">Pr√≥ximo a vencer: ${nextTxt}</div>
          </div>
          <div class="muted" style="text-align:right">
            <div><b>Km actual:</b> ${escapeHtml(String(u.KmRecorridos||0))}</div>
            <div><b>Dominio:</b> ${escapeHtml(u.Dominio||"")}</div>
          </div>
        </div>

        <div class="euUnitGrid">
          ${euKpi("Sociedad", u.Sociedad)}
          ${euKpi("Dep√≥sito", u.Deposito)}
          ${euKpi("Tipo", u.Tipo)}
          ${euKpi("Motor", u.Motor)}
          ${euKpi("Nro. Motor", u["Nro Motor"])}
          ${euKpi("Nro. Chasis", u["Nro. Chasis"])}
        </div>
      </div>
    `;

    const table = `
      <div class="card">
        <div style="font-weight:1000;margin-bottom:10px">Preventivos</div>
        ${rows.length ? `
        <div style="overflow:auto">
          <table class="euTable">
            <thead>
              <tr>
                <th>Preventivo</th>
                <th>Control</th>
                <th>√öltimo</th>
                <th>Cada</th>
                <th>Pr√≥ximo</th>
                <th>Actual</th>
                <th>Restan</th>
                <th>Pasado</th>
                <th>Vence</th>
                <th style="width:90px">Acci√≥n</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map(r => euRow(r)).join("")}
            </tbody>
          </table>
        </div>
        ` : `<div class="muted">Esta unidad todav√≠a no tiene preventivos registrados. (Se crean autom√°ticamente al confirmar una OT preventiva o al reprogramar.)</div>`}
      </div>
    `;

    $("euOut").innerHTML = unitCard + table;
  }

  function euKpi(k, v){
    const val = (v ?? "").toString().trim();
    return `<div class="euKpi"><div class="k muted"><b>${escapeHtml(k)}</b></div><div class="v">${escapeHtml(val || "-")}</div></div>`;
  }

  function euRow(r){
    const cls = `euRow_${r.Estado || "normal"}`;
    const ctrl = (r.Control === "km") ? "KM" : "D√çAS";

    const ultimo = (r.Control === "km") ? String(r.Ultimo||"") : String(r.Ultimo||"");
    const cada   = String(r.Cada||"");
    const prox   = String(r.Proximo||"");
    const actual = String(r.Actual||"");
    const restan = (r.Restan==null? "" : String(r.Restan));
    const pasado = (r.Pasado==null? "" : String(r.Pasado));
    const vence  = String(r.Vence||"-");

    const disabled = r.PendienteOT ? "disabled" : "";
    const titleKey = r.PendienteOT ? "Ya hay una OT pendiente" : "Crear OT preventiva";
    const titleRep = "Reprogramar (queda en historial)";

    return `
      <tr class="${cls}">
        <td><b>${escapeHtml(r.NombreHP||"")}</b></td>
        <td>${ctrl}</td>
        <td>${escapeHtml(ultimo)}</td>
        <td>${escapeHtml(cada)}</td>
        <td>${escapeHtml(prox)}</td>
        <td>${escapeHtml(actual)}</td>
        <td>${escapeHtml(restan)}</td>
        <td>${escapeHtml(pasado)}</td>
        <td>${escapeHtml(vence)}</td>
        <td style="white-space:nowrap">
          <button class="btnIcon" ${disabled} title="${escapeHtml(titleKey)}" onclick="euCrearOT('${escapeHtml(r.IdHP)}')">üîß</button>
          <button class="btnIcon" title="${escapeHtml(titleRep)}" onclick="euAbrirReprog('${escapeHtml(r.IdHP)}','${escapeHtml(r.NombreHP)}','${escapeHtml(r.Control)}')">üóìÔ∏è</button>
        </td>
      </tr>
    `;
  }

  // ----- crear OT desde fila -----
  let EU_PREFILL = null; // {interno, idHP}

  function euCrearOT(idHP){
    if (!EU_LAST?.interno) return;
    EU_PREFILL = { interno: EU_LAST.interno, idHP };
    openOTNewPrev(); // reutiliza m√≥dulo OT preventivo
  }

  // Modifica el flujo de OT preventiva: al cargar el modal, si hay prefill, lo aplica
  // (hook "suave" sin romper nada)
  const _openOTNewPrev_ORIG = openOTNewPrev;
  openOTNewPrev = function(){
    // llamamos al original
    _openOTNewPrev_ORIG();
  };

  // Interceptamos el success handler dentro del original usando un "tick" que espera a que existan selects.
  function euTryApplyPrefill(){
    if (!EU_PREFILL) return false;
    const uSel = $("pOTInterno");
    const hpSel = $("pOTHP");
    if (!uSel || !hpSel || !uSel.options || !hpSel.options) return false;

    // Set interno
    uSel.value = EU_PREFILL.interno;
    if (typeof uSel.onchange === "function") uSel.onchange();

    // Set HP
    hpSel.value = EU_PREFILL.idHP;
    if (typeof hpSel.onchange === "function") hpSel.onchange();

    EU_PREFILL = null;
    return true;
  }

  // Hook global: cuando se abre el modal OT preventiva, intentamos aplicar prefill varias veces sin bloquear
  const _oldModalOpenPrev = window.openOTNewPrev;
  window.openOTNewPrev = function(){
    _oldModalOpenPrev();
    let tries = 0;
    const t = setInterval(()=>{
      tries++;
      if (euTryApplyPrefill() || tries > 30) clearInterval(t);
    }, 100);
  };

  // ----- reprogramaci√≥n -----
  let EU_REP = null; // {interno,idHP,nombre,control}

  function euAbrirReprog(idHP, nombre, control){
    // Normalizar control (puede venir como "KM", "dias", "d√≠a", "d√≠as", etc.)
    const c = (control ?? "").toString().toLowerCase();
    const isKm = c.includes("km");
    const norm = isKm ? "km" : "dias";

    EU_REP = { interno: EU_LAST.interno, idHP, nombre, control: norm };

    $("euRepMsg").style.display = "none";
    $("euRepInterno").value = EU_REP.interno || "";
    $("euRepNombre").value = EU_REP.nombre || "";
    $("euRepSub").innerText = isKm ? "Control por KM" : "Control por d√≠as";
    $("euRepMotivo").value = "";

    $("euRepKmWrap").style.display = isKm ? "block" : "none";
    $("euRepDiasWrap").style.display = isKm ? "none" : "block";

    $("euRepUltKm").value = "";
    $("euRepUltFecha").value = "";

    
    if ($("euRepUltFechaKm")) $("euRepUltFechaKm").value = new Date().toISOString().slice(0,10);
$("modalEUReprog").style.display = "flex";
  }

  function closeEUReprog(){
    $("modalEUReprog").style.display = "none";
    EU_REP = null;
  }

  function showEURepErr(msg){
    $("euRepMsg").style.display = "block";
    $("euRepMsg").innerText = msg;
  }

  function saveEUReprog(){
    if (!EU_REP) return;

    $("euRepMsg").style.display = "none";

    const Motivo = ($("euRepMotivo").value || "").trim();
    const payload = {
      Interno: EU_REP.interno,
      IdHP: EU_REP.idHP,
      Motivo
    };

    if (EU_REP.control === "km"){
      const UltimoKm = ($("euRepUltKm").value || "").trim().replace(/[^\d]/g,"");
      if (!UltimoKm) return showEURepErr("√öltimo Km es obligatorio.");
      payload.UltimoKm = UltimoKm;
    
      const UltimaFechaISO = ($("euRepUltFechaKm")?.value || "").trim();
      if (UltimaFechaISO) payload.UltimaFechaISO = UltimaFechaISO;
} else {
      const UltimaFechaISO = ($("euRepUltFecha").value || "").trim();
      if (!UltimaFechaISO) return showEURepErr("√öltima fecha es obligatoria.");
      payload.UltimaFechaISO = UltimaFechaISO;
    }

    setLoading("btnEURepSave", true);
    google.script.run.withSuccessHandler(res=>{
      setLoading("btnEURepSave", false);
      toast("‚úÖ Reprogramado");
      closeEUReprog();
      buscarEstadoUnidad_UI();
    }).withFailureHandler(err=>{
      setLoading("btnEURepSave", false);
      showEURepErr(err.message || String(err));
    }).reprogramarPreventivoUnidad(TOKEN, payload);
  }


  // ===================== OT MODULE (on-demand) =====================
  let OT_CACHE = [];
  let OT_SELECTED = null; // {head,tasks}
  let OT_FILTERS = { estados:[], sociedades:[], depositos:[], sectores:[] };
  let OT_EMPL = { empleados:[] };

  function showOT(){
    setActiveNav("ot");

    $("view").innerHTML = `
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
          <div>
            <div style="font-size:18px;font-weight:1000">√ìrdenes de Trabajo (OT)</div>
            <div class="muted">No carga todo: busc√° por <b>Interno</b> o <b>N¬∞ OT</b> y toc√° Buscar.</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <button class="btn" onclick="openOTNew()">+ Nueva OT Correctiva</button>
            <button class="btn" onclick="openOTNewPrev()">+ Nueva OT Preventiva</button>
            <button class="btn secondary" onclick="loadOTOptions()">Actualizar filtros</button>
          </div>
        </div>

        <div class="controls">
          <input id="otInterno" placeholder="Interno (ej: 1234)" />
          <input id="otNro" placeholder="N¬∞ OT (solo n√∫meros)" inputmode="numeric" />
          <input id="otDesde" type="date" title="Desde" />
          <input id="otHasta" type="date" title="Hasta" />
          <button class="btn" onclick="searchOT_UI()">Buscar</button>
          <button class="btn secondary" onclick="resetOT_UI()">Limpiar</button>
        </div>

        <div class="card" style="margin-top:10px">
          <div class="muted"><b>Tipo de OT</b></div>
          <div class="radioRow" style="margin-top:8px">
            <label class="rchip"><input type="radio" name="otTipo" value="" checked> Todas</label>
            <label class="rchip"><input type="radio" name="otTipo" value="correctiva"> Correctivas</label>
            <label class="rchip"><input type="radio" name="otTipo" value="preventiva"> Preventivas</label>
          </div>
        </div>

        <div class="controls" style="margin-top:10px">
          <select id="otEstado"><option value="">Estado: todos</option></select>
          <select id="otSoc"><option value="">Sociedad: todas</option></select>
          <select id="otDep"><option value="">Dep√≥sito: todos</option></select>
          <select id="otSec"><option value="">Sector: todos</option></select>
          <select id="otEstT"><option value="">Estado tarea: todos</option>
            <option value="pendiente">pendiente</option>
            <option value="ok">ok</option>
          </select>
          <div class="muted" id="otCount"></div>
        </div>

        <div style="overflow:auto;margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>N¬∞ OT</th>
                <th>Interno</th>
                <th>Tipo</th>
                <th>Preventivo</th>
                <th>Estado</th>
                <th>Sociedad</th>
                <th>Dep√≥sito</th>
                <th>Sector</th>
                <th>Ver</th>
              </tr>
            </thead>
            <tbody id="otBody">
              <tr><td colspan="10" class="muted">Esperando b√∫squeda‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    `;

    $("otNro").addEventListener("input", () => {
      $("otNro").value = $("otNro").value.replace(/[^\d]/g,"");
    });

    loadOTOptions();
  }

  function loadOTOptions(){
    google.script.run.withSuccessHandler(res=>{
      if (res?.ok){
        OT_FILTERS = res;
        fillSelect("otEstado", (res.estados||[]), "", "Estado: todos");
        fillSelect("otSoc", (res.sociedades||[]), "", "Sociedad: todas");
        fillSelect("otDep", (res.depositos||[]), "", "Dep√≥sito: todos");
        fillSelect("otSec", (res.sectores||[]), "", "Sector: todos");
      }
    }).getOTFiltersOptions(TOKEN);

    google.script.run.withSuccessHandler(res=>{
      if (res?.ok) OT_EMPL = res;
    }).getEmpleadosOptions(TOKEN);
  }

  function resetOT_UI(){
    $("otInterno").value = "";
    $("otNro").value = "";
    if ($("otDesde")) $("otDesde").value = "";
    if ($("otHasta")) $("otHasta").value = "";
    $("otEstado").value = "";
    $("otSoc").value = "";
    $("otDep").value = "";
    $("otSec").value = "";
    $("otEstT").value = "";
    document.querySelectorAll("input[name='otTipo']").forEach(r=> r.checked = (r.value===""));
    $("otBody").innerHTML = `<tr><td colspan="10" class="muted">Esperando b√∫squeda‚Ä¶</td></tr>`;
    $("otCount").textContent = "";
    OT_CACHE = [];
  }

  function _getTipoRadio_(){
    const el = document.querySelector("input[name='otTipo']:checked");
    return el ? el.value : "";
  }

  function normEstadoOT(s){
    return (s ?? "")
      .toString()
      .trim()
      .toLowerCase()
      .replace(/\s+/g," ");
  }

  function estadoOTBadge(estado){
    const e = normEstadoOT(estado);

    let cls = "pendiente";
    let label = estado || "pendiente";

    if (e.includes("anul")) { cls = "anulada"; label = "Anulada"; }
    else if (e.includes("parc")) { cls = "parcial"; label = "Parcial"; }
    else if (e.includes("conf") || e.includes("ok") || e.includes("cerr")) { cls = "confirmada"; label = "Confirmada"; }
    else { cls = "pendiente"; label = "Pendiente"; }

    return `<span class="otEstado ${cls}"><span class="dot"></span>${escapeHtml(label)}</span>`;
  }

  // Alias retrocompatible (algunos bloques viejos llaman estadoOT)
  function estadoOT(estado){
    return estadoOTBadge(estado);
  }

  function searchOT_UI(){
    const interno = $("otInterno").value.trim();
    const nroOT = $("otNro").value.trim();

    const q = {
      interno,
      nroOT,
      tipo: _getTipoRadio_(),
      estado: $("otEstado").value,
      sociedad: $("otSoc").value,
      deposito: $("otDep").value,
      sector: $("otSec").value,
      estadoTarea: $("otEstT").value
      ,dateFromMs: (function(){
        const d = ($("otDesde")?.value || "").trim();
        if (!d) return null;
        const dt = new Date(d + "T00:00:00");
        return dt.getTime();
      })()
      ,dateToMs: (function(){
        const d = ($("otHasta")?.value || "").trim();
        if (!d) return null;
        const dt = new Date(d + "T23:59:59");
        return dt.getTime();
      })()
};

    google.script.run.withSuccessHandler(res=>{
      OT_CACHE = res.rows || [];
      $("otCount").textContent = `${OT_CACHE.length} OT(s)`;
      $("otBody").innerHTML = OT_CACHE.map(r=>`
        <tr>
          <td>${fmtDate(r.FechaMs)}</td>
          <td><b>${escapeHtml(fmtOT(r.NroOT))}</b></td>
          <td>${escapeHtml(r.Interno)}</td>
          <td>${escapeHtml(r.TipoOT)}</td>
          <td>${escapeHtml(r.NombrePreventivo || "-")}</td>
          <td>${estadoOTBadge(r.EstadoOT)}</td>
          <td>${escapeHtml(r.Sociedad)}</td>
          <td>${escapeHtml(r.Deposito)}</td>
          <td>${escapeHtml(r.Sector)}</td>
          <td><button class="iconBtn" onclick="openOTView('${escapeHtml(r.IdOT)}')">üëÅÔ∏è</button></td>
        </tr>
      `).join("") || `<tr><td colspan="10" class="muted">Sin resultados.</td></tr>`;
    }).withFailureHandler(err=>{
      $("otBody").innerHTML = `<tr><td colspan="10" class="error">${escapeHtml(err.message||String(err))}</td></tr>`;
    }).searchOT(TOKEN, q);
  }

  // ===================== OT VIEW / CONFIRM =====================
  function openOTView(idOT){
    $("vOTMsg").style.display = "none";
    google.script.run.withSuccessHandler(res=>{
      OT_SELECTED = res;

      const h = res.head;
      $("vNro").textContent = h.NroOT || "-";
      $("vTipo").textContent = h.TipoOT || "-";
      $("vEstado").textContent = h.EstadoOT || "-";
      $("vFecha").textContent = fmtDate(h.FechaMs);

      $("vInt").textContent = h.Interno || "-";
      $("vDom").textContent = h.Dominio || "-";
      $("vSoc").textContent = h.Sociedad || "-";
      $("vDep").textContent = h.Deposito || "-";
      $("vSec").textContent = h.Sector || "-";
      $("vDesc").textContent = h.Descripcion || "";

      const tasks = (res.tasks||[]);
      $("vTasks").innerHTML = tasks.map(t=>`
        <div class="taskRow">
          <div style="min-width:18px">${t.Check ? "‚úÖ" : "‚¨ú"}</div>
          <div style="flex:1">
            <div><b>${escapeHtml(t.CodigoTarea)}</b> ‚Äî ${escapeHtml(t.NombreTarea)}</div>
            <div class="muted" style="font-size:12px">${escapeHtml(t.Sistema)} / ${escapeHtml(t.Subsistema)} / ${escapeHtml(t.Sector)} ‚Äî ${escapeHtml(t.EstadoTarea)}</div>
          </div>
        </div>
      `).join("") || `<div class="muted">Sin tareas.</div>`;

      // ‚úÖ ocultar bot√≥n Confirmar si ya est√° confirmada/ok/cerrada
      const est = (h.EstadoOT || "").toString().trim().toLowerCase();
      const yaConfirmada = (est === "confirmada" || est === "confirmado" || est === "ok" || est === "cerrada" || est === "cerrado");
      const btnC = $("btnOTConfirm");
      if (btnC) btnC.style.display = yaConfirmada ? "none" : "inline-flex";

      $("modalOTView").style.display = "flex";
    }).withFailureHandler(err=>{
      alert(err.message || String(err));
    }).getOTDetails(TOKEN, idOT);
  }

  function closeOTView(){ $("modalOTView").style.display = "none"; }

  function openOTConfirm(){
    if (!OT_SELECTED?.head?.IdOT) return;

    // ‚úÖ bloquear si ya est√° confirmada/ok/cerrada
    const est = (OT_SELECTED?.head?.EstadoOT || "").toString().trim().toLowerCase();
    if (est === "confirmada" || est === "confirmado" || est === "ok" || est === "cerrada" || est === "cerrado") {
      toast("‚úÖ Esta OT ya est√° confirmada.");
      return;
    }

    const opts = (OT_EMPL.empleados||[]);

    const sel = (id, firstLabel)=>{
      const el = $(id);
      if (!el) return;
      el.innerHTML =
        `<option value="">${escapeHtml(firstLabel || "(seleccionar)")}</option>` +
        opts.map(o=>`<option value="${escapeHtml(o.value)}">${escapeHtml(o.label)}</option>`).join("");
    };

    // ‚úÖ labels profesionales
    sel("op1", "Operario 1 (obligatorio)");
    sel("op2", "Operario 2 (opcional)");
    sel("op3", "Operario 3 (opcional)");
    sel("op4", "Operario 4 (opcional)");
    sel("sup1", "Supervisor (obligatorio)");

    const tasks = (OT_SELECTED.tasks||[]);
    $("cTasks").innerHTML = tasks.map(t=>`
      <div class="taskRow">
        <input type="checkbox" class="otchk" data-row="${t._row}" checked />
        <div style="flex:1">
          <div><b>${escapeHtml(t.CodigoTarea)}</b> ‚Äî ${escapeHtml(t.NombreTarea)}</div>
          <div class="muted" style="font-size:12px">${escapeHtml(t.Sistema)} / ${escapeHtml(t.Subsistema)} / ${escapeHtml(t.Sector)}</div>
        </div>
      </div>
    `).join("") || `<div class="muted">Sin tareas.</div>`;

    $("cOTMsg").style.display = "none";
    $("modalOTConfirm").style.display = "flex";
  }

  function closeOTConfirm(){ $("modalOTConfirm").style.display = "none"; }

  function saveOTConfirm(){
    const idOT = OT_SELECTED?.head?.IdOT;
    if (!idOT) return;

    // ‚úÖ Operario 1 obligatorio, otros opcionales
    const op1 = $("op1").value;
    const op2 = $("op2").value;
    const op3 = $("op3").value;
    const op4 = $("op4").value;

    const supervisor = $("sup1").value;

    if (!op1){
      $("cOTMsg").textContent = "Operario 1 es obligatorio.";
      $("cOTMsg").style.display = "block";
      return;
    }

    const operarios = [op1, op2, op3, op4].filter(Boolean);

    // ‚úÖ no repetidos entre los seleccionados
    if (new Set(operarios).size !== operarios.length){
      $("cOTMsg").textContent = "No pod√©s repetir operarios.";
      $("cOTMsg").style.display = "block";
      return;
    }

    if (!supervisor){
      $("cOTMsg").textContent = "Supervisor es obligatorio.";
      $("cOTMsg").style.display = "block";
      return;
    }

    const checks = Array.from(document.querySelectorAll(".otchk")).map(ch => ({
      row: Number(ch.getAttribute("data-row")),
      checked: !!ch.checked
    }));

    setLoading("btnSaveOTConfirm", true);
    google.script.run.withSuccessHandler(res=>{
      setLoading("btnSaveOTConfirm", false);
      toast(`‚úÖ OT ${res.estadoOT.toUpperCase()} (${res.ok}/${res.total})`);
      closeOTConfirm();
      closeOTView();
      searchOT_UI();
    }).withFailureHandler(err=>{
      setLoading("btnSaveOTConfirm", false);
      $("cOTMsg").textContent = err.message || String(err);
      $("cOTMsg").style.display = "block";
    }).confirmarOT(TOKEN, { idOT, operarios, supervisor, checks });
  }

  function openOTAnular(){
    const idOT = OT_SELECTED?.head?.IdOT;
    if (!idOT) return;
    const motivo = prompt("Motivo de anulaci√≥n (opcional):") || "";
    google.script.run.withSuccessHandler(()=>{
      toast("‚õî OT anulada");
      closeOTView();
      searchOT_UI();
    }).withFailureHandler(err=>alert(err.message||String(err)))
      .anularOT(TOKEN, idOT, motivo);
  }

  function printOT(){
    alert("Imprimir OT: siguiente paso (con plantilla Google Doc + PDF).");
  }

  // ===================== CREAR OT (CORRECTIVA) =====================
  let OT_CREATE = { unidades:[], sistemas:[], subsistemas:[], sectores:[], tareas:[] };

  function applyOTUnidad_(){
    const v = ($("nOTInterno")?.value || "").toString().trim();
    const u = (OT_CREATE.unidades || []).find(x => String(x.value || "").trim() === v);

    if (!u){
      $("nOTDominio").value  = "";
      $("nOTSociedad").value = "";
      $("nOTDeposito").value = "";
      return;
    }

    const dom = (u.dominio ?? u.Dominio ?? u.DOMINIO ?? u.dom ?? "").toString();
    const soc = (u.sociedad ?? u.Sociedad ?? u.SOCIEDAD ?? u.soc ?? "").toString();
    const dep = (u.deposito ?? u.Deposito ?? u.DEPOSITO ?? u.dep ?? "").toString();

    $("nOTDominio").value  = dom;
    $("nOTSociedad").value = soc;
    $("nOTDeposito").value = dep;
  }
  function openOTNew(){
    $("nOTMsg").style.display = "none";
    $("modalOTNew").style.display = "flex";

    google.script.run.withSuccessHandler(res=>{
      if (!res?.ok) return;

      OT_CREATE = res;

      // ===== UNIDADES =====
      const uSel = $("nOTInterno");
      uSel.innerHTML = `<option value="">(seleccionar unidad)</option>` +
        (res.unidades||[]).map(u => `
          <option value="${escapeHtml(u.value)}">${escapeHtml(u.label)}</option>
        `).join("");

      uSel.onchange = () => {
        applyOTUnidad_();
        renderNewOTTasks(false);
      };

      // ===== SECTORES (OT) =====
      let sectores = Array.isArray(res.sectores) ? res.sectores.filter(Boolean) : [];

      if (sectores.length === 0 && (res.tareas||[]).length){
        const set = new Set((res.tareas||[]).map(t => (t.sector||"").toString().trim()).filter(Boolean));
        sectores = Array.from(set).sort((a,b)=>a.localeCompare(b,"es"));
      }

      fillSelect("nOTSector", sectores, "");
      if ($("nOTSector")?.options?.length) $("nOTSector").options[0].text = "Sector (OT): seleccionar";

      $("nOTSector").onchange = () => renderNewOTTasks(false);

      // ===== buscador =====
      $("nOTQ").oninput = () => renderNewOTTasks(false);

      // ===== limpiar =====
      $("nOTDominio").value = "";
      $("nOTSociedad").value = "";
      $("nOTDeposito").value = "";
      $("nOTSolicita").value = "";
      $("nOTDesc").value = "";
      $("nOTQ").value = "";

      renderNewOTTasks(false);

    }).withFailureHandler(err=>{
      alert(err.message || String(err));
    }).getOTCreateOptions(TOKEN);

    // datalist de "Qui√©n solicita"
    google.script.run.withSuccessHandler(emp=>{
      if (emp?.ok) OT_EMPL = emp;

      const dl = document.getElementById("nOTSolicitaList");
      if (!dl) return;

      const list = (OT_EMPL?.empleados || []);
      dl.innerHTML = list.map(e =>
        `<option value="${escapeHtml(e.value + " ‚Äî " + e.nombre)}"></option>`
      ).join("");
    }).withFailureHandler(()=>{}).getEmpleadosOptions(TOKEN);
  }

  function closeOTNew(){
    $("modalOTNew").style.display = "none";
  }

  function _norm(s){
    return (s ?? "")
      .toString()
      .trim()
      .toLowerCase()
      .replace(/\s+/g, " ");
  }

  function renderNewOTTasks(first){
    const secOT = ($("nOTSector")?.value || "").trim();
    const q = ($("nOTQ")?.value || "").toLowerCase().trim();

    if (!secOT){
      $("nOTCount").textContent = `Eleg√≠ un Sector (OT) para habilitar la b√∫squeda.`;
      $("nOTTasks").innerHTML = `<div class="muted">‚¨ÖÔ∏è Primero seleccion√° Sector (OT).</div>`;
      return;
    }

    if (!q){
      $("nOTCount").textContent = `Escrib√≠ para buscar tareas dentro de: ${secOT}`;
      $("nOTTasks").innerHTML = `<div class="muted">üîé Busc√° por c√≥digo o nombre‚Ä¶</div>`;
      return;
    }

    const list = (OT_CREATE.tareas||[]).filter(t=>{
      const blob = `${t.codigo||""} ${t.nombre||""}`.toLowerCase();
      const okQ = blob.includes(q);
      const okSec = (t.sector||"").toString().trim() === secOT;
      return okQ && okSec;
    });

    $("nOTCount").textContent = `${list.length} tarea(s) encontradas`;

    $("nOTTasks").innerHTML = list.map(t=>`
      <div class="taskRow">
        <input type="checkbox" class="nOTChk"
          data-cod="${escapeHtml(t.codigo)}"
          data-nom="${escapeHtml(t.nombre)}"
          data-sis="${escapeHtml(t.sistema||"")}"
          data-sub="${escapeHtml(t.subsistema||"")}"
          data-sec="${escapeHtml(t.sector||"")}"
          ${first ? "checked" : ""} />
        <div style="flex:1">
          <div><b>${escapeHtml(t.codigo)}</b> ‚Äî ${escapeHtml(t.nombre)}</div>
          <div class="muted" style="font-size:12px">${escapeHtml(t.sistema||"")} / ${escapeHtml(t.subsistema||"")} / ${escapeHtml(t.sector||"")}</div>
        </div>
      </div>
    `).join("") || `<div class="muted">Sin tareas para ese sector/b√∫squeda.</div>`;
  }

  function setAllNewOT(state){
    document.querySelectorAll(".nOTChk").forEach(ch => ch.checked = !!state);
  }

  function saveOTNew(){
    $("nOTMsg").style.display = "none";

    const Interno = $("nOTInterno").value.trim();
    const Sector = $("nOTSector").value.trim();
    const SolicitaRaw = $("nOTSolicita").value.trim();
    const Descripcion = $("nOTDesc").value.trim();

    if (!Interno) return showNewOTErr("Interno es obligatorio.");
    if (!Sector) return showNewOTErr("Sector es obligatorio.");
    if (!SolicitaRaw) return showNewOTErr("Qui√©n solicita es obligatorio.");

    const Solicita = SolicitaRaw.includes("‚Äî") ? SolicitaRaw.split("‚Äî")[0].trim() : SolicitaRaw;

    const u = (OT_CREATE.unidades||[]).find(x => x.value === Interno) || {};
    const Dominio = (u.dominio || $("nOTDominio").value || "").toString();
    const Sociedad = (u.sociedad || $("nOTSociedad").value || "").toString();
    const Deposito = (u.deposito || $("nOTDeposito").value || "").toString();

    const tareas = Array.from(document.querySelectorAll(".nOTChk"))
      .filter(ch => ch.checked)
      .map(ch => ({
        codigo: ch.getAttribute("data-cod"),
        nombre: ch.getAttribute("data-nom"),
        sistema: ch.getAttribute("data-sis"),
        subsistema: ch.getAttribute("data-sub"),
        sector: ch.getAttribute("data-sec")
      }));

    if (tareas.length === 0) return showNewOTErr("Seleccion√° al menos 1 tarea.");

    setLoading("btnSaveOTNew", true);

    const payload = { Interno, Dominio, Sociedad, Deposito, Sector, Solicita, Descripcion, tareas };

    google.script.run.withSuccessHandler(res=>{
      setLoading("btnSaveOTNew", false);
      toast(`‚úÖ OT creada N¬∞ ${res.NroOT}`);
      closeOTNew();

      if (typeof searchOT_UI === "function"){
        $("otInterno").value = Interno;
        $("otNro").value = "";
        searchOT_UI();
      }
    }).withFailureHandler(err=>{
      setLoading("btnSaveOTNew", false);
      showNewOTErr(err.message || String(err));
    }).addOTCorrectiva(TOKEN, payload);
  }


  // ===================== CREAR OT (PREVENTIVA) =====================
  let OT_PREV_CREATE = { unidades:[], hojas:[] };
  let OT_PREV_HEAD = null;
  let OT_PREV_TASKS = [];

  function closeOTNewPrev(){ $("modalOTNewPrev").style.display = "none"; }

  function showPrevOTErr(msg){
    $("pOTMsg").textContent = msg;
    $("pOTMsg").style.display = msg ? "block" : "none";
  }

  function openOTNewPrev(){
    showPrevOTErr("");
    $("modalOTNewPrev").style.display = "flex";

    $("pOTDominio").value = "";
    $("pOTSociedad").value = "";
    $("pOTDeposito").value = "";
    $("pOTSector").value = "";
    $("pOTDesc").value = "";
    $("pOTTasks").innerHTML = `<div class="muted">Cargando‚Ä¶</div>`;

    google.script.run.withSuccessHandler(res=>{
      if (!res?.ok) return;

      OT_PREV_CREATE = res;

      // Unidades
      const uSel = $("pOTInterno");
      uSel.innerHTML = `<option value="">(seleccionar unidad)</option>` +
        (res.unidades||[]).map(u=>`<option value="${escapeHtml(u.value)}">${escapeHtml(u.label)}</option>`).join("");

      uSel.onchange = ()=>{
        const v = (uSel.value||"").trim();
        const u = (res.unidades||[]).find(x => String(x.value||"").trim() === v);
        $("pOTDominio").value  = (u?.dominio ?? u?.Dominio ?? "").toString();
        $("pOTSociedad").value = (u?.sociedad ?? u?.Sociedad ?? "").toString();
        $("pOTDeposito").value = (u?.deposito ?? u?.Deposito ?? "").toString();
      };

      // Hojas
      const hpSel = $("pOTHP");
      hpSel.innerHTML = `<option value="">(seleccionar hoja preventiva)</option>` +
        (res.hojas||[]).map(h=>`<option value="${escapeHtml(h.IdHP)}">${escapeHtml(h.NombreHP)}${h.Sector ? " ‚Äî "+escapeHtml(h.Sector):""}</option>`).join("");

      // Empleados
      const dl = $("pOTSolicitaList");
      dl.innerHTML = (OT_EMPL.empleados||[]).map(e=>`<option value="${escapeHtml(e.value)}">${escapeHtml(e.label)}</option>`).join("");
      $("pOTSolicita").value = "";

      $("pOTTasks").innerHTML = `<div class="muted">Seleccion√° una hoja preventiva‚Ä¶</div>`;
      OT_PREV_HEAD = null;
      OT_PREV_TASKS = [];

    }).withFailureHandler(err=>{
      showPrevOTErr(err.message || String(err));
      $("pOTTasks").innerHTML = `<div class="muted">No se pudieron cargar datos.</div>`;
    }).getOTPreventivaOptions(TOKEN);
  }

  function onChangePrevHP(){
    showPrevOTErr("");
    const idHP = ($("pOTHP").value || "").trim();

    if (!idHP){
      $("pOTSector").value = "";
      OT_PREV_TASKS = [];
      $("pOTTasks").innerHTML = `<div class="muted">Seleccion√° una hoja preventiva‚Ä¶</div>`;
      return;
    }

    $("pOTTasks").innerHTML = `<div class="muted">Cargando tareas‚Ä¶</div>`;

    google.script.run.withSuccessHandler(res=>{
      OT_PREV_HEAD = res.head || {};
      OT_PREV_TASKS = res.tasks || [];

      $("pOTSector").value = OT_PREV_HEAD.Sector || $("pOTSector").value || "";

      if (!($("pOTDesc").value||"").trim()){
        const n = OT_PREV_HEAD.NombreHP || OT_PREV_HEAD.NombrePreventivo || "";
        $("pOTDesc").value = n ? `Preventivo: ${n}` : "";
      }

      // Render tareas OBLIGATORIAS (sin checkbox)
      $("pOTTasks").innerHTML = OT_PREV_TASKS.map((t,idx)=>{
        const codigo = (t.CodigoTarea ?? t.codigo ?? "").toString().trim();
        const nombre = (t.NombreTarea ?? t.nombre ?? "").toString().trim();
        const sistema = (t.Sistema ?? t.sistema ?? "").toString().trim();
        const subsistema = (t.Subsistema ?? t.subsistema ?? "").toString().trim();
        const sector = (t.Sector ?? t.sector ?? "").toString().trim();

        return `
          <div class="rowHover" style="padding:10px;border:1px solid #e6eef7;border-radius:12px;margin-bottom:8px">
            <div><b>${escapeHtml(codigo || ("T"+(idx+1)))}</b> ‚Äî ${escapeHtml(nombre)}</div>
            <div class="muted" style="font-size:12px">${escapeHtml(sistema||"")} / ${escapeHtml(subsistema||"")} / ${escapeHtml(sector||"")}</div>
          </div>
        `;
      }).join("") || `<div class="muted">La hoja no tiene tareas.</div>`;

    }).withFailureHandler(err=>{
      showPrevOTErr(err.message || String(err));
      $("pOTTasks").innerHTML = `<div class="muted">No se pudieron cargar tareas.</div>`;
    }).getHPDetails(TOKEN, idHP);
  }

  function saveOTNewPrev(){
    showPrevOTErr("");

    const Interno = ($("pOTInterno").value || "").trim();
    const IdHP = ($("pOTHP").value || "").trim();
    const Sector = ($("pOTSector").value || "").trim();
    const SolicitaRaw = ($("pOTSolicita").value || "").trim();
    const Descripcion = ($("pOTDesc").value || "").trim();

    if (!Interno) return showPrevOTErr("Interno es obligatorio.");
    if (!IdHP) return showPrevOTErr("Hoja preventiva es obligatoria.");
    if (!SolicitaRaw) return showPrevOTErr("Qui√©n solicita es obligatorio.");
    if (!OT_PREV_TASKS.length) return showPrevOTErr("La hoja no tiene tareas.");

    // Legajo
    let Solicita = SolicitaRaw;
    const hit = (OT_EMPL.empleados||[]).find(e => e.label === SolicitaRaw);
    if (hit) Solicita = hit.value;

    setLoading("btnSavePrevOT", true);

    google.script.run.withSuccessHandler(res=>{
      setLoading("btnSavePrevOT", false);
      toast(`üßæ OT preventiva creada: #${fmtOT(res.NroOT)}`);
      closeOTNewPrev();
      try{ searchOT_UI(); }catch(e){}
    }).withFailureHandler(err=>{
      setLoading("btnSavePrevOT", false);
      showPrevOTErr(err.message || String(err));
    }).addOTPreventiva(TOKEN, { Interno, IdHP, Sector, Solicita, Descripcion });
  }



  function showNewOTErr(msg){
    $("nOTMsg").textContent = msg;
    $("nOTMsg").style.display = "block";
  }
 // ===================== HOJAS PREVENTIVAS MODULE =====================
let HP_CACHE = [];
let HP_FILTERS = { sectores:[], estados:[] };
let HP_CREATE = { tareas:[], sectores:[] };

// dual-list en modal
let HP_AVAIL = [];        // todas las tareas (base)
let HP_SELECTED = [];     // seleccionadas [{codigo,nombre,sistema,subsistema,sector}]

function showHP(){
  setActiveNav("hp");

  $("view").innerHTML = `
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
        <div>
          <div style="font-size:18px;font-weight:1000">Hojas Preventivas</div>
          <div class="muted">No carga todo: busc√° por <b>nombre</b> o filtr√° y toc√° <b>Buscar</b>.</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <button class="btn" id="btnHPNew" onclick="openHPNew()">+ Nueva Hoja</button>
          <button class="btn secondary" onclick="loadHPOptions()">Actualizar filtros</button>
        </div>
      </div>

      <div class="controls" style="margin-top:10px">
        <input id="hpNombre" placeholder="Nombre de la hoja (ej: Aire acondicionado)" />
        <select id="hpSector"><option value="">Sector: todos</option></select>
        <select id="hpEstado">
          <option value="">Estado: todos</option>
          <option value="activo">activo</option>
          <option value="inactivo">inactivo</option>
        </select>
        <button class="btn" onclick="searchHP_UI()">Buscar</button>
        <button class="btn secondary" onclick="resetHP_UI()">Limpiar</button>
        <div class="muted" id="hpCount"></div>
      </div>

      <div style="overflow:auto;margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Sector</th>
              <th>Frecuencia</th>
              <th>Estado</th>
              <th>Creado</th>
              <th>Ver</th>
              <th id="hpThEdit" style="display:none">Editar</th>
            </tr>
          </thead>
          <tbody id="hpBody">
            <tr><td colspan="7" class="muted">Esperando b√∫squeda‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  `;

  // ‚úÖ solo ADMIN ve ‚ÄúNueva Hoja‚Äù y ‚ÄúEditar‚Äù
  $("btnHPNew").style.display = IS_ADMIN ? "inline-flex" : "none";
  $("hpThEdit").style.display = IS_ADMIN ? "table-cell" : "none";

  loadHPOptions();
}

function hpFreqLabel_(r){
  const km = String(r?.CadaKm || "").trim();
  const di = String(r?.CadaDias || "").trim();
  const parts = [];
  if (km) parts.push(`Cada ${km} km`);
  if (di) parts.push(`Cada ${di} d√≠as`);
  return parts.length ? parts.join(" / ") : "-";
}

function loadHPOptions(){
  google.script.run.withSuccessHandler(res=>{
    if (res?.ok){
      HP_FILTERS = res;
      fillSelect("hpSector", (res.sectores||[]), "", "Sector: todos");
    }
  }).getHPFiltersOptions(TOKEN);
}

function resetHP_UI(){
  $("hpNombre").value = "";
  $("hpSector").value = "";
  $("hpEstado").value = "";
  $("hpCount").textContent = "";
  $("hpBody").innerHTML = `<tr><td colspan="7" class="muted">Esperando b√∫squeda‚Ä¶</td></tr>`;
  HP_CACHE = [];
}

function hpEstadoBadge(estado){
  const e = (estado||"").toString().trim().toLowerCase();
  const cls = e === "inactivo" ? "inactivo" : "activo";
  const label = cls === "inactivo" ? "inactivo" : "activo";
  return `<span class="estado ${cls}"><span class="dot2"></span>${escapeHtml(label)}</span>`;
}

function searchHP_UI(){
  const q = {
    nombre: $("hpNombre").value.trim(),
    sector: $("hpSector").value,
    estado: $("hpEstado").value
  };

  google.script.run.withSuccessHandler(res=>{
    HP_CACHE = res.rows || [];
    $("hpCount").textContent = `${HP_CACHE.length} hoja(s)`;

    const cols = IS_ADMIN ? 7 : 6;

    $("hpBody").innerHTML = HP_CACHE.map(r=>`
      <tr>
        <td><b>${escapeHtml(r.NombreHP)}</b></td>
        <td>${escapeHtml(r.Sector)}</td>
        <td>${escapeHtml(hpFreqLabel_(r))}</td>
        <td>${hpEstadoBadge(r.Estado)}</td>
        <td class="muted">${escapeHtml((r.CreadoEl||"").toString().slice(0,19).replace("T"," "))}</td>
        <td>
          <button class="iconBtn" onclick="openHPView('${escapeHtml(r.IdHP)}')">üëÅÔ∏è</button>
        </td>
        ${IS_ADMIN ? `
          <td>
            <button class="mini" onclick="openHPEdit('${escapeHtml(r.IdHP)}')">Editar</button>
          </td>
        ` : ``}
      </tr>
    `).join("") || `<tr><td colspan="${cols}" class="muted">Sin resultados.</td></tr>`;
  }).withFailureHandler(err=>{
    const cols = IS_ADMIN ? 7 : 6;
    $("hpBody").innerHTML = `<tr><td colspan="${cols}" class="error">${escapeHtml(err.message||String(err))}</td></tr>`;
  }).searchHojasPreventivas(TOKEN, q);
}

// ===== OJITO (usa backend getHPDetails que ya trae head + tasks) =====
function openHPView(idHP){
  $("vHPMsg").style.display = "none";
  $("vHPTareas").innerHTML = `<div class="muted">Cargando‚Ä¶</div>`;
  $("modalHPView").style.display = "flex";

  google.script.run.withSuccessHandler(res=>{
    const h = res.head || {};
    const tasks = res.tasks || [];

    $("vHPNombre").textContent = h.NombreHP || "-";
    $("vHPSector").textContent = h.Sector || "-";
    $("vHPFreq").textContent  = hpFreqLabel_(h);
    $("vHPEstado").textContent = h.Estado || "-";
    $("vHPDesc").textContent  = h.Descripcion || "";

    $("vHPTareas").innerHTML = tasks.map(t=>`
      <div class="taskRow">
        <div style="min-width:18px">üõ†Ô∏è</div>
        <div style="flex:1">
          <div><b>${escapeHtml(t.CodigoTarea||"")}</b> ‚Äî ${escapeHtml(t.NombreTarea||"")}</div>
          <div class="muted" style="font-size:12px">
            ${escapeHtml(t.Sistema||"")} / ${escapeHtml(t.Subsistema||"")} / ${escapeHtml(t.Sector||"")}
          </div>
        </div>
      </div>
    `).join("") || `<div class="muted">Sin tareas cargadas.</div>`;
  }).withFailureHandler(err=>{
    $("vHPMsg").textContent = err.message || String(err);
    $("vHPMsg").style.display = "block";
    $("vHPTareas").innerHTML = `<div class="muted">-</div>`;
  }).getHPDetails(TOKEN, idHP);
}

function closeHPView(){
  $("modalHPView").style.display = "none";
}

// ===== MODAL NUEVA HOJA =====
function openHPNew(){
  if (!$("modalHPNew")) return alert("No se encontr√≥ modalHPNew. Revis√° ui_modals.html.");

  $("hpNewMsg").style.display = "none";
  $("modalHPNew").style.display = "flex";

  $("hpNewNombre").value = "";
  $("hpNewDesc").value = "";
  $("hpNewEstado").value = "activo";
  $("hpNewQ").value = "";
  if ($("hpNewCadaKm")) $("hpNewCadaKm").value = "";
  if ($("hpNewCadaDias")) $("hpNewCadaDias").value = "";

  HP_SELECTED = [];

  google.script.run.withSuccessHandler(res=>{
    if (!res?.ok) return;

    HP_CREATE = res;
    fillSelect("hpNewSector", (res.sectores||[]), "", "Sector: seleccionar");

    HP_AVAIL = res.tareas || [];
    renderHPLists();
  }).withFailureHandler(err=>{
    alert(err.message||String(err));
  }).getHPCreateOptions(TOKEN);
}

function closeHPNew(){ $("modalHPNew").style.display = "none"; }

function renderHPLists(){
  const sec = ($("hpNewSector").value || "").trim();
  const q = ($("hpNewQ").value || "").toLowerCase().trim();

  const avail = (HP_AVAIL||[]).filter(t=>{
    if (!sec) return false;
    const okSec = String(t.sector||"").trim() === sec;
    const blob = `${t.codigo||""} ${t.nombre||""}`.toLowerCase();
    const okQ = !q || blob.includes(q);
    const already = HP_SELECTED.some(x => x.codigo === t.codigo);
    return okSec && okQ && !already;
  });

  $("hpAvailCount").textContent = sec ? `${avail.length} disponible(s)` : `Eleg√≠ un sector‚Ä¶`;
  $("hpSelCount").textContent = `${HP_SELECTED.length} seleccionada(s)`;

  $("hpAvail").innerHTML = sec
    ? (avail.map(t=>`
        <div class="taskRow">
          <div style="flex:1">
            <div><b>${escapeHtml(t.codigo)}</b> ‚Äî ${escapeHtml(t.nombre)}</div>
            <div class="muted" style="font-size:12px">${escapeHtml(t.sistema||"")} / ${escapeHtml(t.subsistema||"")} / ${escapeHtml(t.sector||"")}</div>
          </div>
          <button class="mini" onclick="hpAddTask('${escapeHtml(t.codigo)}')">‚û°Ô∏è</button>
        </div>
      `).join("") || `<div class="muted">Sin tareas.</div>`)
    : `<div class="muted">‚¨ÖÔ∏è Primero seleccion√° el <b>Sector</b> de la hoja.</div>`;

  $("hpSelected").innerHTML = HP_SELECTED.map(t=>`
    <div class="taskRow">
      <div style="flex:1">
        <div><b>${escapeHtml(t.codigo)}</b> ‚Äî ${escapeHtml(t.nombre)}</div>
        <div class="muted" style="font-size:12px">${escapeHtml(t.sistema||"")} / ${escapeHtml(t.subsistema||"")} / ${escapeHtml(t.sector||"")}</div>
      </div>
      <button class="mini" onclick="hpRemoveTask('${escapeHtml(t.codigo)}')">‚¨ÖÔ∏è</button>
    </div>
  `).join("") || `<div class="muted">Todav√≠a no seleccionaste tareas.</div>`;
}

function hpAddTask(cod){
  const t = (HP_AVAIL||[]).find(x => x.codigo === cod);
  if (!t) return;
  HP_SELECTED.push({
    codigo: t.codigo,
    nombre: t.nombre,
    sistema: t.sistema,
    subsistema: t.subsistema,
    sector: t.sector
  });
  renderHPLists();
}

function hpRemoveTask(cod){
  HP_SELECTED = HP_SELECTED.filter(x => x.codigo !== cod);
  renderHPLists();
}

function showHPNewErr(msg){
  $("hpNewMsg").textContent = msg;
  $("hpNewMsg").style.display = "block";
}

function saveHPNew(){
  $("hpNewMsg").style.display = "none";

  const NombreHP = $("hpNewNombre").value.trim();
  const Sector = $("hpNewSector").value.trim();
  const Descripcion = $("hpNewDesc").value.trim();
  const Estado = $("hpNewEstado").value.trim() || "activo";

  const CadaKm = ($("hpNewCadaKm") ? $("hpNewCadaKm").value.trim().replace(/[^\d]/g,"") : "");
  const CadaDias = ($("hpNewCadaDias") ? $("hpNewCadaDias").value.trim().replace(/[^\d]/g,"") : "");
  const AvisoKm = ($("hpNewAvisoKm") ? $("hpNewAvisoKm").value.trim().replace(/[^\d]/g,"") : "");
  const AvisoDias = ($("hpNewAvisoDias") ? $("hpNewAvisoDias").value.trim().replace(/[^\d]/g,"") : "");

  if (!NombreHP) return showHPNewErr("Nombre de hoja es obligatorio.");
  if (!Sector) return showHPNewErr("Sector es obligatorio.");
  if (!CadaKm && !CadaDias) return showHPNewErr("Frecuencia obligatoria: complet√° Cada Km o Cada D√≠as.");
  if (HP_SELECTED.length === 0) return showHPNewErr("Seleccion√° al menos 1 tarea.");

  const tareas = HP_SELECTED.map((t, idx) => ({
    CodigoTarea: t.codigo,
    NombreTarea: t.nombre,
    Sistema: t.sistema || "",
    Subsistema: t.subsistema || "",
    Sector: t.sector || Sector,
    Orden: idx + 1
  }));

  setLoading("btnSaveHPNew", true);

  const payload = { NombreHP, Sector, Descripcion, Estado, CadaKm, CadaDias, tareas };

  google.script.run.withSuccessHandler(res=>{
    setLoading("btnSaveHPNew", false);
    toast("‚úÖ Hoja preventiva creada");
    closeHPNew();

    // refrescar listado
    if (typeof searchHP_UI === "function") {
      $("hpNombre").value = NombreHP;
      searchHP_UI();
    }
  }).withFailureHandler(err=>{
    setLoading("btnSaveHPNew", false);
    showHPNewErr(err.message || String(err));
  }).addHojaPreventiva(TOKEN, payload);
}

// ===== EDITAR HOJA PREVENTIVA (UI) =====
let HP_EDIT_ID = null;
let HP_EDIT_AVAIL = [];     // tareas base (maestro)
let HP_EDIT_SELECTED = [];  // tareas seleccionadas para esa hoja (ordenadas)

function openHPEdit(idHP){
  if (!IS_ADMIN) return alert("Solo administradores pueden editar.");

  if (!$("modalHPEdit")) return alert("No se encontr√≥ modalHPEdit. Revis√° ui_modals.html.");

  HP_EDIT_ID = String(idHP || "").trim();
  if (!HP_EDIT_ID) return alert("IdHP inv√°lido.");

  $("hpEditMsg").style.display = "none";
  $("modalHPEdit").style.display = "flex";

  // Limpieza
  $("hpEditNombre").value = "";
  $("hpEditDesc").value = "";
  $("hpEditEstado").value = "activo";
  $("hpEditQ").value = "";
  $("hpEditCadaKm").value = "";
  $("hpEditCadaDias").value = "";
  if ($("hpEditAvisoKm")) $("hpEditAvisoKm").value = "";
  if ($("hpEditAvisoDias")) $("hpEditAvisoDias").value = "";
  HP_EDIT_SELECTED = [];
  HP_EDIT_AVAIL = [];

  // 1) Traer detalles actuales de la hoja (cabecera + tareas)
  google.script.run.withSuccessHandler(res=>{
    const h = res.head || {};
    const tasks = res.tasks || [];

    $("hpEditNombre").value = h.NombreHP || "";
    $("hpEditDesc").value = h.Descripcion || "";
    $("hpEditEstado").value = (h.Estado || "activo").toLowerCase();
    $("hpEditCadaKm").value = String(h.CadaKm || "").replace(/[^\d]/g,"");
    $("hpEditCadaDias").value = String(h.CadaDias || "").replace(/[^\d]/g,"");
    if ($("hpEditAvisoKm")) $("hpEditAvisoKm").value = String(h.AvisoKm || "").replace(/[^\d]/g,"");
    if ($("hpEditAvisoDias")) $("hpEditAvisoDias").value = String(h.AvisoDias || "").replace(/[^\d]/g,"");

    HP_EDIT_SELECTED = tasks.map(t => ({
      codigo: t.CodigoTarea || "",
      nombre: t.NombreTarea || "",
      sistema: t.Sistema || "",
      subsistema: t.Subsistema || "",
      sector: t.Sector || (h.Sector || "")
    })).filter(x => x.codigo && x.nombre);

    // 2) Traer maestro para ‚Äúdisponibles‚Äù + sectores
    google.script.run.withSuccessHandler(opt=>{
      if (opt?.ok){
        HP_EDIT_AVAIL = opt.tareas || [];
        fillSelect("hpEditSector", (opt.sectores||[]), (h.Sector||""), "Sector: seleccionar");
      } else {
        fillSelect("hpEditSector", [], (h.Sector||""), "Sector: seleccionar");
      }

      // Si el sector actual no existe en la lista, lo dejamos seleccionado igual
      const sec = (h.Sector || "").toString().trim();
      if (sec && $("hpEditSector") && !Array.from($("hpEditSector").options).some(o => o.value === sec)){
        const o = document.createElement("option");
        o.value = sec; o.textContent = sec; o.selected = true;
        $("hpEditSector").appendChild(o);
      } else {
        $("hpEditSector").value = sec;
      }

      renderHPEditLists();
    }).withFailureHandler(err=>{
      $("hpEditMsg").textContent = err.message || String(err);
      $("hpEditMsg").style.display = "block";
    }).getHPCreateOptions(TOKEN);

  }).withFailureHandler(err=>{
    $("hpEditMsg").textContent = err.message || String(err);
    $("hpEditMsg").style.display = "block";
  }).getHPDetails(TOKEN, HP_EDIT_ID);
}

function closeHPEdit(){
  $("modalHPEdit").style.display = "none";
  HP_EDIT_ID = null;
}

function renderHPEditLists(){
  const sec = ($("hpEditSector").value || "").trim();
  const q = ($("hpEditQ").value || "").toLowerCase().trim();

  const avail = (HP_EDIT_AVAIL||[]).filter(t=>{
    if (!sec) return false;
    const okSec = String(t.sector||"").trim() === sec;
    const blob = `${t.codigo||""} ${t.nombre||""}`.toLowerCase();
    const okQ = !q || blob.includes(q);
    const already = HP_EDIT_SELECTED.some(x => x.codigo === t.codigo);
    return okSec && okQ && !already;
  });

  $("hpEditAvailCount").textContent = sec ? `${avail.length} disponible(s)` : `Eleg√≠ un sector‚Ä¶`;
  $("hpEditSelCount").textContent = `${HP_EDIT_SELECTED.length} seleccionada(s)`;

  $("hpEditAvail").innerHTML = sec
    ? (avail.map(t=>`
        <div class="taskRow">
          <div style="flex:1">
            <div><b>${escapeHtml(t.codigo)}</b> ‚Äî ${escapeHtml(t.nombre)}</div>
            <div class="muted" style="font-size:12px">${escapeHtml(t.sistema||"")} / ${escapeHtml(t.subsistema||"")} / ${escapeHtml(t.sector||"")}</div>
          </div>
          <button class="mini" onclick="hpEditAddTask('${escapeHtml(t.codigo)}')">‚û°Ô∏è</button>
        </div>
      `).join("") || `<div class="muted">Sin tareas.</div>`)
    : `<div class="muted">‚¨ÖÔ∏è Primero seleccion√° el <b>Sector</b> de la hoja.</div>`;

  $("hpEditSelected").innerHTML = HP_EDIT_SELECTED.map((t,idx)=>`
    <div class="taskRow">
      <div style="display:flex;gap:6px;align-items:center">
        <button class="mini" onclick="hpEditMove(${idx}, -1)">‚¨ÜÔ∏è</button>
        <button class="mini" onclick="hpEditMove(${idx}, 1)">‚¨áÔ∏è</button>
      </div>

      <div style="flex:1">
        <div><b>${escapeHtml(t.codigo)}</b> ‚Äî ${escapeHtml(t.nombre)}</div>
        <div class="muted" style="font-size:12px">${escapeHtml(t.sistema||"")} / ${escapeHtml(t.subsistema||"")} / ${escapeHtml(t.sector||"")}</div>
      </div>

      <button class="mini" onclick="hpEditRemoveTask('${escapeHtml(t.codigo)}')">‚¨ÖÔ∏è</button>
    </div>
  `).join("") || `<div class="muted">Todav√≠a no seleccionaste tareas.</div>`;
}

function hpEditAddTask(cod){
  const t = (HP_EDIT_AVAIL||[]).find(x => x.codigo === cod);
  if (!t) return;
  HP_EDIT_SELECTED.push({
    codigo: t.codigo,
    nombre: t.nombre,
    sistema: t.sistema,
    subsistema: t.subsistema,
    sector: t.sector
  });
  renderHPEditLists();
}

function hpEditRemoveTask(cod){
  HP_EDIT_SELECTED = HP_EDIT_SELECTED.filter(x => x.codigo !== cod);
  renderHPEditLists();
}

function hpEditMove(idx, dir){
  const j = idx + dir;
  if (idx < 0 || idx >= HP_EDIT_SELECTED.length) return;
  if (j < 0 || j >= HP_EDIT_SELECTED.length) return;
  const tmp = HP_EDIT_SELECTED[idx];
  HP_EDIT_SELECTED[idx] = HP_EDIT_SELECTED[j];
  HP_EDIT_SELECTED[j] = tmp;
  renderHPEditLists();
}

function showHPEditErr(msg){
  $("hpEditMsg").textContent = msg;
  $("hpEditMsg").style.display = "block";
}

function saveHPEdit(){
  $("hpEditMsg").style.display = "none";

  if (!HP_EDIT_ID) return showHPEditErr("IdHP inv√°lido.");

  const NombreHP = $("hpEditNombre").value.trim();
  const Sector = $("hpEditSector").value.trim();
  const Descripcion = $("hpEditDesc").value.trim();
  const Estado = ($("hpEditEstado").value || "activo").trim().toLowerCase();

  const CadaKm = ($("hpEditCadaKm").value || "").toString().replace(/[^\d]/g,"");
  const CadaDias = ($("hpEditCadaDias").value || "").toString().replace(/[^\d]/g,"");

  if (!NombreHP) return showHPEditErr("Nombre de hoja es obligatorio.");
  if (!Sector) return showHPEditErr("Sector es obligatorio.");
  if (!CadaKm && !CadaDias) return showHPEditErr("Frecuencia obligatoria: complet√° Cada Km o Cada D√≠as.");
  if (HP_EDIT_SELECTED.length === 0) return showHPEditErr("Seleccion√° al menos 1 tarea.");

  const tareas = HP_EDIT_SELECTED.map((t, idx) => ({
    CodigoTarea: t.codigo,
    NombreTarea: t.nombre,
    Sistema: t.sistema || "",
    Subsistema: t.subsistema || "",
    Sector: t.sector || Sector,
    Orden: idx + 1
  }));

  setLoading("btnSaveHPEdit", true);

  const payload = { IdHP: HP_EDIT_ID, NombreHP, Sector, Descripcion, Estado, CadaKm, CadaDias, tareas };

  google.script.run.withSuccessHandler(()=>{
    setLoading("btnSaveHPEdit", false);
    toast("‚úÖ Cambios guardados");
    closeHPEdit();
    // refrescar la b√∫squeda
    if (typeof searchHP_UI === "function") searchHP_UI();
  }).withFailureHandler(err=>{
    setLoading("btnSaveHPEdit", false);
    showHPEditErr(err.message || String(err));
  }).updateHojaPreventiva(TOKEN, payload);
}



  render();
</script>
